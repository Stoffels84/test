<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>Schadeanalyse</title>

    <!-- Excel inlezen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Grafieken voor Voertuig-tab -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
    /* ====== Basis layout & thema ====== */
    :root {
        --bg-page: #f3f4f6;
        --bg-box: #ffffff;
        --border-soft: #e5e7eb;
        --accent: #2563eb;
        --accent-soft: #dbeafe;
        --text-main: #111827;
        --text-muted: #6b7280;
        --table-header: #f9fafb;
        --hover-row: #f3f4ff;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.06);
        --radius-lg: 14px;
    }
    
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }
    
    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top left, #e5e7eb, #f9fafb 40%, #e5e7eb);
        color: var(--text-main);
    }
    
    /* ====== Hoofdcontainer ====== */
    .box {
        max-width: 1200px;
        margin: 24px auto 32px;
        padding: 24px 28px 28px;
        background: var(--bg-box);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    h1 {
        margin-top: 0;
        margin-bottom: 4px;
        font-size: 24px;
        letter-spacing: 0.02em;
    }
    
    #status {
        margin-top: 0;
        margin-bottom: 16px;
        color: var(--text-muted);
        font-size: 13px;
    }
    
    /* ====== Bovenste filterbalk ====== */
    #top-filters {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0 10px;
        font-size: 13px;
        color: var(--text-muted);
    }
    
    #year-filter {
        padding: 6px 10px;
        font-size: 13px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #f9fafb;
        outline: none;
    }
    
    #year-filter:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
    }
    
    /* ====== Tabs ====== */
    .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        border-bottom: 1px solid var(--border-soft);
        margin-bottom: 10px;
    }
    
    .tab-button {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-muted);
        transition: background 0.15s, color 0.15s, border-color 0.15s, transform 0.05s;
    }
    
    .tab-button:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
    }
    
    .tab-button.active {
        background: var(--accent-soft);
        color: var(--accent);
        border-color: rgba(37, 99, 235, 0.3);
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
        padding-top: 8px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* ====== Tabellen & wrappers ====== */
    .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 10px;
        border-radius: 10px;
        border: 1px solid var(--border-soft);
        background: #ffffff;
    }
    
    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
        table-layout: auto;
    }
    
    th,
    td {
        border-bottom: 1px solid var(--border-soft);
        padding: 6px 8px;
        text-align: left;
        max-width: 260px;
        white-space: normal;
        word-wrap: break-word;
    }
    
    th {
        background: var(--table-header);
        position: sticky;
        top: 0;
        z-index: 1;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: #4b5563;
    }
    
    tbody tr:nth-child(even) {
        background: #fcfcff;
    }
    
    tbody tr:hover {
        background: var(--hover-row);
    }
    
    /* Detailrijen */
    .chauffeur-detail-row td,
    .voertuig-detail-row td,
    .locatie-detail-row td {
        background: #f9fafb;
    }
    
    /* ====== Links ====== */
    a.table-link {
        color: var(--accent);
        text-decoration: none;
        font-weight: 500;
        font-size: 12px;
    }
    
    a.table-link::after {
        content: " ↗";
        font-size: 10px;
    }
    
    a.table-link:hover {
        text-decoration: underline;
    }
    
    /* ====== Zoekvelden & selecties ====== */
    #search-input,
    #dashboard-search-input {
        padding: 7px 10px;
        width: 280px;
        max-width: 100%;
        margin: 4px 0 10px;
        border: 1px solid var(--border-soft);
        border-radius: 999px;
        font-size: 13px;
        background: #f9fafb;
        outline: none;
    }
    
    #search-input:focus,
    #dashboard-search-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
        background: #ffffff;
    }
    
    #chauffeur-limit,
    #voertuig-limit,
    #locatie-limit {
        padding: 5px 10px;
        font-size: 13px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #f9fafb;
        outline: none;
        margin-left: 4px;
    }
    
    #chauffeur-limit:focus,
    #voertuig-limit:focus,
    #locatie-limit:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent-soft);
    }
    
    /* ====== Knoppen ====== */
    #dashboard-search-button {
        padding: 7px 14px;
        font-size: 13px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        background: #f3f4f6;
        cursor: pointer;
        margin-top: 4px;
        transition: background 0.15s, border-color 0.15s, transform 0.05s;
    }
    
    #dashboard-search-button:hover {
        background: var(--accent-soft);
        border-color: rgba(37, 99, 235, 0.35);
        transform: translateY(-1px);
    }
    
    /* Info-tekst dashboard */
    #dashboard-info {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }
    
    /* ====== Tekst / placeholders ====== */
    .placeholder-text {
        color: var(--text-muted);
        font-size: 13px;
        margin-top: 10px;
    }
    
    /* ====== Charts ====== */
    .chart-container {
        margin-top: 16px;
        height: 260px;
    }
    
    /* ====== Hover gedrag rijen selectie (Chauffeur, Voertuig, Locatie) ====== */
    #chauffeur-table tbody tr,
    #voertuig-table tbody tr,
    #locatie-table tbody tr {
        cursor: pointer;
    }
    
    /* ====== Responsive ====== */
    @media (max-width: 900px) {
        .box {
            margin: 12px;
            padding: 16px 14px 20px;
            border-radius: 10px;
        }
    
        h1 {
            font-size: 20px;
        }
    
        .tabs {
            gap: 6px;
        }
    
        .tab-button {
            font-size: 12px;
            padding: 5px 10px;
        }
    
        th,
        td {
            padding: 5px 6px;
            font-size: 12px;
        }
    
        #top-filters {
            flex-wrap: wrap;
            align-items: flex-start;
        }
    }
    
    @media (max-width: 600px) {
        #search-input,
        #dashboard-search-input {
            width: 100%;
        }
    }
    </style>
</head>
<body>

<div class="box">
    <h1>Schadeanalyse</h1>

    <div id="top-filters">
        <label for="year-filter">Jaar:
            <select id="year-filter">
                <option value="ALL">Alle jaren</option>
                <!-- Jaren worden dynamisch ingevuld -->
            </select>
        </label>
    </div>

    <p id="status">Bezig met laden van het Excel-bestand...</p>

    <!-- TAB KNOPPEN -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-all">1. Alle data</button>
        <button class="tab-button" data-tab="tab-chauffeur">2. Chauffeur</button>
        <button class="tab-button" data-tab="tab-voertuig">3. Voertuig</button>
        <button class="tab-button" data-tab="tab-locatie">4. Locatie</button>
        <button class="tab-button" data-tab="tab-dashboard">5. Dashboard (opzoeken)</button>
        <button class="tab-button" data-tab="tab-coaching">6. Coaching</button>
        <button class="tab-button" data-tab="tab-analyse">7. Analyse</button>
    </div>

    <!-- TAB 1: ALLE DATA (BRON) -->
    <div class="tab-content active" id="tab-all">
        <h2>Alle data (tabblad BRON)</h2>
        <p>Hier zie je alle ruwe gegevens uit het Excel-tabblad <strong>BRON</strong>. De jaarfilter bovenaan werkt op alle tabs.</p>

        <input id="search-input" type="text" placeholder="Zoeken in alle kolommen..." />

        <div class="table-container">
            <table id="tabel">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 2: CHAUFFEUR -->
    <div class="tab-content" id="tab-chauffeur">
        <h2>Data rond chauffeur</h2>
        <p>Overzicht van aantal schades per chauffeur (gefilterd op gekozen jaar). Klik op een chauffeur voor details direct onder de rij.</p>

        <label for="chauffeur-limit">Toon:
            <select id="chauffeur-limit">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="0">Alle chauffeurs</option>
            </select>
        </label>

        <div class="table-container">
            <table id="chauffeur-table">
                <thead>
                    <tr>
                        <th>Chauffeur</th>
                        <th>Aantal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 3: VOERTUIG -->
    <div class="tab-content" id="tab-voertuig">
        <h2>Data rond voertuig (Bus/Tram)</h2>
        <p>Overzicht van aantal schades per type voertuig op basis van kolom <strong>Bus/Tram</strong>. Klik op een type voor details direct onder de rij.</p>

        <label for="voertuig-limit">Toon:
            <select id="voertuig-limit">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="0">Alle types</option>
            </select>
        </label>

        <div class="table-container">
            <table id="voertuig-table">
                <thead>
                    <tr>
                        <th>Type voertuig</th>
                        <th>Aantal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>Schades per maand en voertuigtype</h3>
        <p style="font-size:13px;color:#555;">
            Deze grafiek respecteert de gekozen jaarfilter bovenaan. <br>
            X-as = maanden, kleur = voertuigtype (Bus/Tram).
        </p>
        <div class="chart-container">
            <canvas id="voertuig-month-chart"></canvas>
        </div>
    </div>

    <!-- TAB 4: LOCATIE -->
    <div class="tab-content" id="tab-locatie">
        <h2>Data rond locatie</h2>
        <p>Overzicht van aantal schades per locatie (gefilterd op gekozen jaar). Klik op een locatie voor details direct onder de rij.</p>

        <label for="locatie-limit">Toon:
            <select id="locatie-limit">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="0">Alle locaties</option>
            </select>
        </label>

        <div class="table-container">
            <table id="locatie-table">
                <thead>
                    <tr>
                        <th>Locatie</th>
                        <th>Aantal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 5: DASHBOARD / OPZOEKEN -->
    <div class="tab-content" id="tab-dashboard">
        <h2>Dashboard – Chauffeur opzoeken</h2>
        <p>Zoek op <strong>personeelsnummer</strong> of <strong>naam</strong>. De resultaten worden gefilterd op het geselecteerde jaar bovenaan.</p>

        <input id="dashboard-search-input" type="text" placeholder="Personeelsnr of naam..." />
        <button id="dashboard-search-button">Zoeken</button>
        <div id="dashboard-info">Tip: je kunt een deel van de naam of het nummer ingeven.</div>

        <div class="table-container" style="margin-top:10px;">
            <table id="dashboard-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Naam</th>
                        <th>Personeelsnr</th>
                        <th>Voertuigtype</th>
                        <th>Locatie</th>
                        <th>Actief</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 6: COACHING -->
    <div class="tab-content" id="tab-coaching">
        <h2>Coaching</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Bijvoorbeeld overzicht van coaching-acties per chauffeur.
        </p>
    </div>

    <!-- TAB 7: ANALYSE -->
    <div class="tab-content" id="tab-analyse">
        <h2>Analyse</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Hier kun je diepere analyses doen op patronen in de data.
        </p>
    </div>

</div>

<script>
    const statusEl = document.getElementById('status');
    const table = document.getElementById('tabel');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const searchInput = document.getElementById('search-input');
    const yearFilterSelect = document.getElementById('year-filter');

    const excelFileUrl = 'schade%20met%20macro.xlsm';

    // globale data
    let allHeaders = [];
    let baseRows = [];        // alle rijen uit BRON (on-gefilterd)
    let filteredRows = [];    // rijen na jaarfilter
    let dateColIndex = -1;
    let chauffeurColIndex = -1;
    let voertuigColIndex = -1;
    let locatieColIndex = -1;
    let linkColIndex = -1;
    let personnelColIndex = -1;
    let activeColIndex = -1;

    let chauffeurData = [];
    let voertuigData = [];
    let locatieData = [];
    let voertuigMonthChart = null;

    // ---- Tabs ----
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-tab');

            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            tabContents.forEach(tc => {
                if (tc.id === targetId) {
                    tc.classList.add('active');
                } else {
                    tc.classList.remove('active');
                }
            });
        });
    });

    // ---- Zoekfunctie Alle data ----
    searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toLowerCase();
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let rowMatch = false;

            for (let c = 0; c < cells.length; c++) {
                if (cells[c].textContent.toLowerCase().includes(filter)) {
                    rowMatch = true;
                    break;
                }
            }

            rows[i].style.display = rowMatch ? '' : 'none';
        }
    });

    // ---- Excel-seriedatum -> Date-object ----
    function excelSerialToDate(cell) {
        if (typeof cell === 'number') {
            const excelEpoch = Date.UTC(1899, 11, 30); // 30 dec 1899
            const millis = cell * 24 * 60 * 60 * 1000;
            return new Date(excelEpoch + millis);
        }
        if (typeof cell === 'string') {
            const parts = cell.split(/[\/\-]/);
            if (parts.length === 3) {
                let [a, b, c] = parts.map(p => p.trim());
                let day, month, year;

                if (a.length === 4) { // jjjj-mm-dd
                    year = parseInt(a, 10);
                    month = parseInt(b, 10);
                    day = parseInt(c, 10);
                } else { // dd/mm/jjjj
                    day = parseInt(a, 10);
                    month = parseInt(b, 10);
                    year = parseInt(c, 10);
                }
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                    return new Date(Date.UTC(year, month - 1, day));
                }
            }
            const d = new Date(cell);
            if (!isNaN(d)) return d;
        }
        return null;
    }

    // ---- Date -> dd/mm/jjjj ----
    function excelSerialToDateString(cell) {
        const date = excelSerialToDate(cell);
        if (!date) return cell;

        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    }

    // ---- Helper: kolomindex zoeken op naam ----
    function findColumnIndexByNames(headers, possibleNames) {
        const lower = headers.map(h => String(h).toLowerCase().trim());
        for (const name of possibleNames) {
            const idx = lower.indexOf(name.toLowerCase());
            if (idx !== -1) return idx;
        }
        return -1;
    }

    // ---- Jaren in dropdown stoppen ----
    function populateYearFilter() {
        yearFilterSelect.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = 'Alle jaren';
        yearFilterSelect.appendChild(optAll);

        if (dateColIndex === -1) return;

        const yearSet = new Set();
        baseRows.forEach(row => {
            const d = excelSerialToDate(row[dateColIndex]);
            if (d) yearSet.add(d.getUTCFullYear());
        });

        const years = Array.from(yearSet).sort((a, b) => a - b);
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = String(y);
            opt.textContent = y;
            yearFilterSelect.appendChild(opt);
        });
    }

    // ---- Filter: welke rijen horen bij huidig jaar? ----
    function getFilteredRows() {
        if (dateColIndex === -1) return baseRows;
        const value = yearFilterSelect.value;
        if (!value || value === 'ALL') return baseRows;

        const yearInt = parseInt(value, 10);
        if (isNaN(yearInt)) return baseRows;

        return baseRows.filter(row => {
            const d = excelSerialToDate(row[dateColIndex]);
            return d && d.getUTCFullYear() === yearInt;
        });
    }

    // ---- Helper: maak cel (met klikbare link indien kolom Link) ----
    function createCell(idx, rawValue) {
        let value = rawValue;
        if (idx === dateColIndex) {
            value = excelSerialToDateString(rawValue);
        }
        const td = document.createElement('td');

        if (idx === linkColIndex && value) {
            const href = String(value).trim();
            const a = document.createElement('a');
            a.href = href;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.className = 'table-link';
            a.textContent = '=> naar EAF';
            td.appendChild(a);
        } else {
            td.textContent = (value === null || value === undefined) ? '' : value;
        }
        return td;
    }

    // ---- Alle data body opnieuw opbouwen ----
    function rebuildAllDataTableBody(rows) {
        tbody.innerHTML = '';

        rows.forEach(r => {
            const tr = document.createElement('tr');

            r.forEach((cell, idx) => {
                const td = createCell(idx, cell);
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // ---- Chauffeur-aggregatie opbouwen ----
    function buildChauffeurData(rows) {
        chauffeurData = [];
        if (chauffeurColIndex === -1) {
            console.warn('Geen chauffeur-kolom gevonden.');
            return;
        }

        const map = new Map(); // naam -> {name, count, rows:[]}

        rows.forEach(row => {
            let name = row[chauffeurColIndex];
            name = (name && String(name).trim() !== '') ? String(name).trim() : 'Onbekend';

            if (!map.has(name)) {
                map.set(name, { name: name, count: 0, rows: [] });
            }
            const entry = map.get(name);
            entry.count++;
            entry.rows.push(row);
        });

        chauffeurData = Array.from(map.values()).sort((a, b) => b.count - a.count);
    }

    // ---- Voertuig-aggregatie opbouwen (Bus/Tram) ----
    function buildVoertuigData(rows) {
        voertuigData = [];
        if (voertuigColIndex === -1) {
            console.warn('Geen voertuig-kolom (Bus/Tram) gevonden.');
            return;
        }

        const map = new Map(); // type -> {type, count, rows:[]}

        rows.forEach(row => {
            let type = row[voertuigColIndex];
            type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';

            if (!map.has(type)) {
                map.set(type, { type: type, count: 0, rows: [] });
            }
            const entry = map.get(type);
            entry.count++;
            entry.rows.push(row);
        });

        voertuigData = Array.from(map.values()).sort((a, b) => b.count - a.count);
    }

    // ---- Locatie-aggregatie opbouwen ----
    function buildLocatieData(rows) {
        locatieData = [];
        if (locatieColIndex === -1) {
            console.warn('Geen locatie-kolom gevonden.');
            return;
        }

        const map = new Map(); // locatie -> {locatie, count, rows:[]}

        rows.forEach(row => {
            let loc = row[locatieColIndex];
            loc = (loc && String(loc).trim() !== '') ? String(loc).trim() : 'Onbekend';

            if (!map.has(loc)) {
                map.set(loc, { locatie: loc, count: 0, rows: [] });
            }
            const entry = map.get(loc);
            entry.count++;
            entry.rows.push(row);
        });

        locatieData = Array.from(map.values()).sort((a, b) => b.count - a.count);
    }

    // ---- Chauffeur details inline (toggle) ----
    function showChauffeurDetailsInline(name, clickedRow) {
        const tbodyCh = document.querySelector('#chauffeur-table tbody');

        const nextRow = clickedRow.nextElementSibling;
        if (nextRow && nextRow.classList.contains('chauffeur-detail-row')) {
            nextRow.remove();
            return;
        }

        Array.from(tbodyCh.querySelectorAll('.chauffeur-detail-row')).forEach(r => r.remove());

        const entry = chauffeurData.find(c => c.name === name);
        if (!entry) return;

        const headers = allHeaders;
        const cols = [];

        const addCol = (possibleNames) => {
            const idx = findColumnIndexByNames(headers, possibleNames);
            if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
        };

        if (chauffeurColIndex !== -1) cols.push(chauffeurColIndex);
        addCol(['datum']);
        addCol(['locatie']);
        addCol(['bus/ tram', 'bus/tram']);
        addCol(['link']);

        const detailTr = document.createElement('tr');
        detailTr.className = 'chauffeur-detail-row';
        const detailTd = document.createElement('td');
        detailTd.colSpan = 2;

        const innerTable = document.createElement('table');
        innerTable.style.width = '100%';
        innerTable.style.fontSize = '12px';

        const theadInner = document.createElement('thead');
        const hr = document.createElement('tr');
        cols.forEach(idx => {
            const th = document.createElement('th');
            th.textContent = headers[idx];
            hr.appendChild(th);
        });
        theadInner.appendChild(hr);

        const tbodyInner = document.createElement('tbody');
        entry.rows.forEach(row => {
            const tr = document.createElement('tr');
            cols.forEach(idx => {
                const td = createCell(idx, row[idx]);
                tr.appendChild(td);
            });
            tbodyInner.appendChild(tr);
        });

        innerTable.appendChild(theadInner);
        innerTable.appendChild(tbodyInner);

        detailTd.appendChild(innerTable);
        detailTr.appendChild(detailTd);

        clickedRow.insertAdjacentElement('afterend', detailTr);
    }

    // ---- Voertuig details inline (toggle) ----
    function showVoertuigDetailsInline(type, clickedRow) {
        const tbodyV = document.querySelector('#voertuig-table tbody');

        const nextRow = clickedRow.nextElementSibling;
        if (nextRow && nextRow.classList.contains('voertuig-detail-row')) {
            nextRow.remove();
            return;
        }

        Array.from(tbodyV.querySelectorAll('.voertuig-detail-row')).forEach(r => r.remove());

        const entry = voertuigData.find(v => v.type === type);
        if (!entry) return;

        const headers = allHeaders;
        const cols = [];

        const addCol = (possibleNames) => {
            const idx = findColumnIndexByNames(headers, possibleNames);
            if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
        };

        if (voertuigColIndex !== -1) cols.push(voertuigColIndex);
        addCol(['volledige naam', 'chauffeur', 'naam', 'bestuurder']);
        addCol(['datum']);
        addCol(['locatie']);
        addCol(['link']);

        const detailTr = document.createElement('tr');
        detailTr.className = 'voertuig-detail-row';
        const detailTd = document.createElement('td');
        detailTd.colSpan = 2;

        const innerTable = document.createElement('table');
        innerTable.style.width = '100%';
        innerTable.style.fontSize = '12px';

        const theadInner = document.createElement('thead');
        const hr = document.createElement('tr');
        cols.forEach(idx => {
            const th = document.createElement('th');
            th.textContent = headers[idx];
            hr.appendChild(th);
        });
        theadInner.appendChild(hr);

        const tbodyInner = document.createElement('tbody');
        entry.rows.forEach(row => {
            const tr = document.createElement('tr');
            cols.forEach(idx => {
                const td = createCell(idx, row[idx]);
                tr.appendChild(td);
            });
            tbodyInner.appendChild(tr);
        });

        innerTable.appendChild(theadInner);
        innerTable.appendChild(tbodyInner);

        detailTd.appendChild(innerTable);
        detailTr.appendChild(detailTd);

        clickedRow.insertAdjacentElement('afterend', detailTr);
    }

    // ---- Locatie details inline (toggle) ----
    function showLocatieDetailsInline(loc, clickedRow) {
        const tbodyL = document.querySelector('#locatie-table tbody');

        const nextRow = clickedRow.nextElementSibling;
        if (nextRow && nextRow.classList.contains('locatie-detail-row')) {
            nextRow.remove();
            return;
        }

        Array.from(tbodyL.querySelectorAll('.locatie-detail-row')).forEach(r => r.remove());

        const entry = locatieData.find(l => l.locatie === loc);
        if (!entry) return;

        const headers = allHeaders;
        const cols = [];

        const addCol = (possibleNames) => {
            const idx = findColumnIndexByNames(headers, possibleNames);
            if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
        };

        if (locatieColIndex !== -1) cols.push(locatieColIndex);
        addCol(['volledige naam', 'chauffeur', 'naam', 'bestuurder']);
        addCol(['datum']);
        addCol(['bus/ tram', 'bus/tram']);
        addCol(['link']);

        const detailTr = document.createElement('tr');
        detailTr.className = 'locatie-detail-row';
        const detailTd = document.createElement('td');
        detailTd.colSpan = 2;

        const innerTable = document.createElement('table');
        innerTable.style.width = '100%';
        innerTable.style.fontSize = '12px';

        const theadInner = document.createElement('thead');
        const hr = document.createElement('tr');
        cols.forEach(idx => {
            const th = document.createElement('th');
            th.textContent = headers[idx];
            hr.appendChild(th);
        });
        theadInner.appendChild(hr);

        const tbodyInner = document.createElement('tbody');
        entry.rows.forEach(row => {
            const tr = document.createElement('tr');
            cols.forEach(idx => {
                const td = createCell(idx, row[idx]);
                tr.appendChild(td);
            });
            tbodyInner.appendChild(tr);
        });

        innerTable.appendChild(theadInner);
        innerTable.appendChild(tbodyInner);

        detailTd.appendChild(innerTable);
        detailTr.appendChild(detailTd);

        clickedRow.insertAdjacentElement('afterend', detailTr);
    }

    // ---- Chauffeur tabel updaten ----
    function updateChauffeurView() {
        const limitSelect = document.getElementById('chauffeur-limit');
        const tbodyCh = document.querySelector('#chauffeur-table tbody');
        tbodyCh.innerHTML = '';

        let limit = parseInt(limitSelect.value, 10);
        if (isNaN(limit) || limit < 0) limit = 10;

        const list = (limit === 0) ? chauffeurData : chauffeurData.slice(0, limit);

        list.forEach(ch => {
            const tr = document.createElement('tr');
            tr.dataset.chauffeur = ch.name;

            const tdName = document.createElement('td');
            tdName.textContent = ch.name;
            const tdCount = document.createElement('td');
            tdCount.textContent = ch.count;

            tr.appendChild(tdName);
            tr.appendChild(tdCount);

            tr.addEventListener('click', () => showChauffeurDetailsInline(ch.name, tr));

            tbodyCh.appendChild(tr);
        });
    }

    // ---- Voertuig tabel updaten ----
    function updateVoertuigView() {
        const limitSelect = document.getElementById('voertuig-limit');
        const tbodyV = document.querySelector('#voertuig-table tbody');
        tbodyV.innerHTML = '';

        let limit = parseInt(limitSelect.value, 10);
        if (isNaN(limit) || limit < 0) limit = 10;

        const list = (limit === 0) ? voertuigData : voertuigData.slice(0, limit);

        list.forEach(v => {
            const tr = document.createElement('tr');
            tr.dataset.type = v.type;

            const tdType = document.createElement('td');
            tdType.textContent = v.type;
            const tdCount = document.createElement('td');
            tdCount.textContent = v.count;

            tr.appendChild(tdType);
            tr.appendChild(tdCount);

            tr.addEventListener('click', () => showVoertuigDetailsInline(v.type, tr));

            tbodyV.appendChild(tr);
        });
    }

    // ---- Locatie tabel updaten ----
    function updateLocatieView() {
        const limitSelect = document.getElementById('locatie-limit');
        const tbodyL = document.querySelector('#locatie-table tbody');
        tbodyL.innerHTML = '';

        let limit = parseInt(limitSelect.value, 10);
        if (isNaN(limit) || limit < 0) limit = 10;

        const list = (limit === 0) ? locatieData : locatieData.slice(0, limit);

        list.forEach(l => {
            const tr = document.createElement('tr');
            tr.dataset.locatie = l.locatie;

            const tdLoc = document.createElement('td');
            tdLoc.textContent = l.locatie;
            const tdCount = document.createElement('td');
            tdCount.textContent = l.count;

            tr.appendChild(tdLoc);
            tr.appendChild(tdCount);

            tr.addEventListener('click', () => showLocatieDetailsInline(l.locatie, tr));

            tbodyL.appendChild(tr);
        });
    }

    // ---- Grafiek Voertuig: schades per maand en type ----
    function buildVoertuigMonthChart(rows) {
        const canvas = document.getElementById('voertuig-month-chart');
        if (!canvas || voertuigColIndex === -1 || dateColIndex === -1) return;
        const ctx = canvas.getContext('2d');

        if (voertuigMonthChart) {
            voertuigMonthChart.destroy();
        }

        const monthLabels = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];

        const typeSet = new Set();
        rows.forEach(row => {
            let type = row[voertuigColIndex];
            type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';
            typeSet.add(type);
        });
        const types = Array.from(typeSet).sort();

        const dataByType = {};
        types.forEach(t => {
            dataByType[t] = new Array(12).fill(0);
        });

        rows.forEach(row => {
            const d = excelSerialToDate(row[dateColIndex]);
            if (!d) return;
            let type = row[voertuigColIndex];
            type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';
            if (!dataByType[type]) {
                dataByType[type] = new Array(12).fill(0);
            }
            const m = d.getUTCMonth();
            dataByType[type][m] += 1;
        });

        const datasets = types.map(t => ({
            label: t,
            data: dataByType[t]
        }));

        voertuigMonthChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    // ---- Dashboard zoeken op personeelsnr / naam ----
    function searchDashboard() {
        const input = document.getElementById('dashboard-search-input');
        const term = input.value.trim().toLowerCase();
        const tbodyDash = document.querySelector('#dashboard-table tbody');
        tbodyDash.innerHTML = '';

        if (!term) {
            // niets tonen als zoekveld leeg is
            return;
        }

        const rows = filteredRows;
        const results = [];

        rows.forEach(row => {
            const nameVal = (chauffeurColIndex !== -1 && row[chauffeurColIndex]) ?
                String(row[chauffeurColIndex]).toLowerCase() : '';
            const persVal = (personnelColIndex !== -1 && row[personnelColIndex]) ?
                String(row[personnelColIndex]).toLowerCase() : '';

            if (nameVal.includes(term) || persVal.includes(term)) {
                results.push(row);
            }
        });

        if (results.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 7;
            td.textContent = 'Geen resultaten gevonden voor deze zoekopdracht (binnen de gekozen jaarfilter).';
            tr.appendChild(td);
            tbodyDash.appendChild(tr);
            return;
        }

        // kolommen die we willen tonen
        const cols = [];
        if (dateColIndex !== -1) cols.push(dateColIndex);
        if (chauffeurColIndex !== -1) cols.push(chauffeurColIndex);
        if (personnelColIndex !== -1) cols.push(personnelColIndex);
        if (voertuigColIndex !== -1) cols.push(voertuigColIndex);
        if (locatieColIndex !== -1) cols.push(locatieColIndex);
        if (activeColIndex !== -1) cols.push(activeColIndex);
        if (linkColIndex !== -1) cols.push(linkColIndex);

        results.forEach(row => {
            const tr = document.createElement('tr');
            cols.forEach(idx => {
                const td = createCell(idx, row[idx]);
                tr.appendChild(td);
            });
            tbodyDash.appendChild(tr);
        });
    }

    // ---- Alles heropbouwen wanneer filter verandert ----
    function updateFilterAndViews() {
        filteredRows = getFilteredRows();
        rebuildAllDataTableBody(filteredRows);
        buildChauffeurData(filteredRows);
        buildVoertuigData(filteredRows);
        buildLocatieData(filteredRows);
        updateChauffeurView();
        updateVoertuigView();
        updateLocatieView();
        buildVoertuigMonthChart(filteredRows);
        // Dashboard opnieuw toepassen op basis van huidige zoekterm
        searchDashboard();

        const filterText = (yearFilterSelect.value === 'ALL'
            ? 'alle jaren'
            : 'jaar ' + yearFilterSelect.value);
        statusEl.textContent = 'Klaar. ' + filteredRows.length +
            ' rijen geladen (' + filterText + ').';
    }

    // ---- Select-listeners ----
    document.getElementById('chauffeur-limit').addEventListener('change', () => {
        updateChauffeurView();
    });
    document.getElementById('voertuig-limit').addEventListener('change', () => {
        updateVoertuigView();
    });
    document.getElementById('locatie-limit').addEventListener('change', () => {
        updateLocatieView();
    });
    yearFilterSelect.addEventListener('change', () => {
        updateFilterAndViews();
    });

    // Dashboard zoeklisteners
    document.getElementById('dashboard-search-button').addEventListener('click', () => {
        searchDashboard();
    });
    document.getElementById('dashboard-search-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            searchDashboard();
        }
    });

    // ---- Init data uit Excel ----
    fetch(excelFileUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Kon het Excel-bestand niet laden (HTTP ' + response.status + ')');
            }
            return response.arrayBuffer();
        })
        .then(data => {
            statusEl.textContent = 'Excel-bestand geladen, bezig met verwerken...';

            const uint8 = new Uint8Array(data);
            const workbook = XLSX.read(uint8, { type: 'array' });

            const sheetName = 'BRON';
            if (!workbook.SheetNames.includes(sheetName)) {
                statusEl.textContent = "Tabblad 'BRON' bestaat niet in het Excel-bestand!";
                return;
            }

            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (!rows || rows.length === 0) {
                statusEl.textContent = 'Geen data gevonden in tabblad BRON.';
                return;
            }

            // basisgegevens
            allHeaders = rows[0];
            baseRows = rows.slice(1);

            // tabel header invullen (Alle data)
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            allHeaders.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // kolommen zoeken
            dateColIndex = findColumnIndexByNames(allHeaders, ['datum']);
            chauffeurColIndex = findColumnIndexByNames(
                allHeaders,
                ['volledige naam', 'chauffeur', 'naam', 'bestuurder']
            );
            voertuigColIndex = findColumnIndexByNames(
                allHeaders,
                ['bus/tram', 'bus/ tram']
            );
            locatieColIndex = findColumnIndexByNames(
                allHeaders,
                ['locatie']
            );
            linkColIndex = findColumnIndexByNames(
                allHeaders,
                ['link']
            );
            personnelColIndex = findColumnIndexByNames(
                allHeaders,
                ['personeelsnr', 'personeelsnummer', 'personeels nr']
            );
            activeColIndex = findColumnIndexByNames(
                allHeaders,
                ['actief', 'active']
            );

            // jaren in filter
            populateYearFilter();

            // eerste keer views opbouwen
            updateFilterAndViews();
        })
        .catch(err => {
            console.error(err);
            statusEl.textContent = 'Er ging iets mis bij het laden of verwerken van het Excel-bestand.';
        });
</script>

</body>
</html>

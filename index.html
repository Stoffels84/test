<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Huishoudbudget Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Stijl -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f5f5f7;
      color: #222;
    }
    header {
      background: #111827;
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    header h1 span {
      font-size: 1.6rem;
    }
    main {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 60px);
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      aside {
        order: 2;
      }
      section.content {
        order: 1;
      }
    }
    aside {
      background: #020617;
      color: white;
      padding: 1rem;
      border-right: 1px solid #1f2937;
    }
    aside h2 {
      font-size: 1.05rem;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    aside label {
      font-size: 0.85rem;
      display: block;
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
    }
    aside select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: none;
      background: #111827;
      color: white;
      font-size: 0.85rem;
    }
    aside small {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    aside .info {
      margin-top: 1rem;
      font-size: 0.85rem;
      padding: 0.5rem;
      background: #020617;
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
    }
    section.content {
      padding: 1rem 1.5rem 2rem;
      overflow-x: auto;
    }

    .sidebar-tabs {
      margin-top: 1.2rem;
    }
    .sidebar-tabs-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      opacity: 0.9;
    }
    .sidebar-tabs .tab-button {
      width: 100%;
      text-align: left;
      padding: 0.45rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .sidebar-tabs .tab-button span.icon {
      font-size: 1rem;
    }
    .sidebar-tabs .tab-button.active {
      background: #e5e7eb;
      color: #020617;
      border-color: #e5e7eb;
    }

    .tab-panel {
      display: none;
      background: #ffffff;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      margin-top: 0.5rem;
    }
    .tab-panel.active {
      display: block;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .kpi-card {
      background: #f9fafb;
      border-radius: 0.75rem;
      padding: 0.8rem 1rem;
      border: 1px solid #e5e7eb;
    }
    .kpi-label {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .kpi-value {
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 0.2rem;
    }
    .kpi-delta {
      font-size: 0.8rem;
      color: #059669;
      margin-top: 0.2rem;
    }
    .table-wrapper {
      margin-top: 1rem;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background: #fafafa;
    }
    .chip {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 0.75rem;
      font-size: 0.75rem;
      background: #e5e7eb;
    }
    .chip.income {
      background: #ecfdf3;
      color: #166534;
    }
    .chip.expense {
      background: #fef2f2;
      color: #b91c1c;
    }
    .status {
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }
    .status.error {
      color: #f97316;
    }
    canvas {
      max-width: 100%;
    }
  </style>

  <!-- Excel (SheetJS) + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <h1><span>üí∂</span> Huishoudbudget dashboard</h1>
    <div style="font-size:0.8rem; opacity:0.8;">Laadt automatisch huishoud.xlsx (tabblad ‚ÄúData‚Äù)</div>
  </header>

  <main>
    <aside>
      <h2>Data</h2>
      <div id="fileStatus" class="status">Probeer huishoud.xlsx te laden‚Ä¶</div>
      <small>
        Bestanden in deze map: <strong>index.html</strong> en <strong>huishoud.xlsx</strong>.<br />
        Gegevens staan in tabblad <strong>Data</strong> met kolommen:<br />
        <strong>datum, bedrag, categorie, in/uitgave, vast/variabel</strong>.
      </small>

      <div id="filters" class="hidden">
        <h2 style="margin-top:1.2rem;">Filters</h2>

        <label for="yearSelect">Jaar</label>
        <select id="yearSelect" multiple></select>

        <label for="typeSelect">In/uitgave</label>
        <select id="typeSelect" multiple></select>

        <label for="categorySelect">Categorie</label>
        <select id="categorySelect" multiple></select>

        <label for="vvSelect">Vast / variabel</label>
        <select id="vvSelect" multiple></select>

        <label for="topSelect">Top aantal categorie√´n</label>
        <select id="topSelect">
          <option value="10">Top 10</option>
          <option value="20">Top 20</option>
          <option value="50">Top 50</option>
          <option value="all">Alle</option>
        </select>

        <div class="info">
          <div>Transacties na filters: <strong><span id="transactionCount">0</span></strong></div>
        </div>

        <div class="sidebar-tabs">
          <div class="sidebar-tabs-title">Weergave</div>
          <button class="tab-button active" data-tab="overview">
            <span class="icon">üìä</span> Overzicht
          </button>
          <button class="tab-button" data-tab="category">
            <span class="icon">üìÇ</span> Per categorie
          </button>
          <button class="tab-button" data-tab="month">
            <span class="icon">üìÖ</span> Per maand
          </button>
          <button class="tab-button" data-tab="transactions">
            <span class="icon">üìÑ</span> Transacties
          </button>
        </div>
      </div>
    </aside>

    <section class="content">
      <div id="tab-overview" class="tab-panel active">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Totaal inkomsten</div>
            <div id="kpiIncome" class="kpi-value">‚Ç¨ 0,00</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Totaal uitgaven</div>
            <div id="kpiExpense" class="kpi-value">‚Ç¨ 0,00</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Saldo</div>
            <div id="kpiBalance" class="kpi-value">‚Ç¨ 0,00</div>
            <div id="kpiBalanceDelta" class="kpi-delta"></div>
          </div>
        </div>

        <h3>Saldo per maand</h3>
        <div style="height:220px;">
          <canvas id="balanceByMonthChart"></canvas>
        </div>
      </div>

      <div id="tab-category" class="tab-panel">
        <h3>Netto per categorie</h3>
        <div style="height:260px;">
          <canvas id="byCategoryChart"></canvas>
        </div>

        <div class="table-wrapper">
          <table id="categoryTable">
            <thead>
              <tr>
                <th>Categorie</th>
                <th>Netto (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab-month" class="tab-panel">
        <h3>Maandelijkse samenvatting</h3>
        <div class="table-wrapper">
          <table id="monthTable">
            <thead>
              <tr>
                <th>Jaar-maand</th>
                <th>Inkomsten (‚Ç¨)</th>
                <th>Uitgaven (‚Ç¨)</th>
                <th>Netto (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="tab-transactions" class="tab-panel">
        <h3>Transacties</h3>
        <div class="table-wrapper">
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Datum</th>
                <th>In/uitgave</th>
                <th>Categorie</th>
                <th>Vast/variabel</th>
                <th>Bedrag (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ------- STATE -------
    let rawData = [];
    let filteredData = [];
    let headerMap = {};
    let balanceByMonthChart = null;
    let byCategoryChart = null;

    // ------- HELPERS -------
    function formatEuro(value) {
      return new Intl.NumberFormat("nl-BE", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2
      }).format(value || 0);
    }

    function getSelectedValues(selectEl) {
      return Array.from(selectEl.selectedOptions).map(opt => opt.value);
    }

    function uniqueValues(array, key) {
      return Array.from(new Set(array.map(row => row[key]).filter(v => v !== null && v !== ""))).sort();
    }

    function excelSerialDateToJSDate(serial) {
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      return new Date(excelEpoch.getTime() + serial * 86400000);
    }

    function normalizeKey(key) {
      return key.toString().toLowerCase().trim().replace(/\s+/g, "");
    }

    function buildHeaderMap(json) {
      headerMap = {};
      if (!json || !json.length) return;
      const firstRow = json[0];
      Object.keys(firstRow).forEach(origKey => {
        const norm = normalizeKey(origKey);
        if (!headerMap[norm]) headerMap[norm] = origKey;
      });
      console.log("Gevonden kolommen:", headerMap);
    }

    function getCol(nameOptions) {
      for (const opt of nameOptions) {
        if (headerMap[opt]) return headerMap[opt];
      }
      return null;
    }

    function parseExcelDate(rawDate) {
      if (rawDate instanceof Date) return rawDate;
      if (typeof rawDate === "number") return excelSerialDateToJSDate(rawDate);
      if (typeof rawDate === "string") {
        const s = rawDate.trim();
        if (!s) return null;

        let d = new Date(s);
        if (!isNaN(d.getTime())) return d;

        const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
        if (m) {
          let day = parseInt(m[1], 10);
          let month = parseInt(m[2], 10);
          let year = parseInt(m[3], 10);
          if (year < 100) year += 2000;
          d = new Date(year, month - 1, day);
          if (!isNaN(d.getTime())) return d;
        }
      }
      return null;
    }

    // ------- EXCEL LADEN AUTOMATISCH -------
    const fileStatus = document.getElementById("fileStatus");
    const filtersBox = document.getElementById("filters");

    async function loadExcelAutomatically() {
      try {
        fileStatus.textContent = "huishoud.xlsx aan het laden‚Ä¶";

        const resp = await fetch("huishoud.xlsx");
        if (!resp.ok) {
          fileStatus.textContent = "Kan huishoud.xlsx niet vinden. Staat hij in dezelfde map als index.html?";
          fileStatus.classList.add("error");
          return;
        }

        const data = await resp.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array", cellDates: true });

        const sheetName = "Data";
        if (!workbook.SheetNames.includes(sheetName)) {
          fileStatus.textContent = "Tabblad 'Data' niet gevonden in huishoud.xlsx.";
          fileStatus.classList.add("error");
          return;
        }

        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "", cellDates: true });
        console.log("Ruwe rijen in Data:", json.length);

        buildHeaderMap(json);
        rawData = preprocessData(json);
        console.log("Rijen na verwerken:", rawData.length);

        if (!rawData.length) {
          fileStatus.textContent = "Geen geldige rijen gevonden (datum/bedrag leeg?).";
          fileStatus.classList.add("error");
          return;
        }

        fileStatus.textContent = `huishoud.xlsx geladen (${rawData.length} transacties).`;
        filtersBox.classList.remove("hidden");

        initFilters();
        applyFiltersAndUpdate();
      } catch (err) {
        console.error(err);
        fileStatus.textContent = "Fout bij het laden van huishoud.xlsx.";
        fileStatus.classList.add("error");
      }
    }

    function preprocessData(data) {
      const colDatum = getCol(["datum", "date", "data"]);
      const colBedrag = getCol(["bedrag", "amount", "waarde"]);
      const colCategorie = getCol(["categorie", "category"]);
      const colType = getCol(["in/uitgave", "inuitgave", "inuit", "type"]);
      const colVV = getCol(["vast/variabel", "vastvariabel", "vastofvariabel"]);

      console.log("Kolommen gebruikt:", { colDatum, colBedrag, colCategorie, colType, colVV });

      return data.map(row => {
        let rawDate = colDatum ? row[colDatum] : null;
        let date = parseExcelDate(rawDate);
        if (!date || isNaN(date.getTime())) return null;

        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const yearMonth = `${year}-${String(month).padStart(2, "0")}`;

        let bedragRaw = colBedrag ? row[colBedrag] : 0;
        let bedrag;
        if (typeof bedragRaw === "number") {
          bedrag = bedragRaw;
        } else {
          bedrag = parseFloat(bedragRaw.toString().replace(",", ".")) || 0;
        }

        const typeRaw = colType ? (row[colType] || "").toString().trim() : "";
        const isIncome = typeRaw.toLowerCase().startsWith("in");
        const netto = isIncome ? bedrag : -bedrag;

        const categorie = colCategorie ? (row[colCategorie] || "").toString().trim() : "";
        const vastVar = colVV ? (row[colVV] || "").toString().trim() : "";

        return {
          datum: date,
          datumStr: date.toISOString().slice(0, 10),
          year,
          month,
          yearMonth,
          type: typeRaw,
          categorie,
          vastvariabel: vastVar,
          bedrag,
          netto
        };
      }).filter(r => r !== null);
    }

    // ------- FILTERS & UPDATES -------
    const yearSelect = document.getElementById("yearSelect");
    const typeSelect = document.getElementById("typeSelect");
    const categorySelect = document.getElementById("categorySelect");
    const vvSelect = document.getElementById("vvSelect");
    const topSelect = document.getElementById("topSelect");
    const transactionCount = document.getElementById("transactionCount");

    function initFilters() {
      yearSelect.innerHTML = "";
      uniqueValues(rawData, "year").forEach(year => {
        const opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year;
        opt.selected = true;
        yearSelect.appendChild(opt);
      });

      typeSelect.innerHTML = "";
      uniqueValues(rawData, "type").forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        opt.selected = true;
        typeSelect.appendChild(opt);
      });

      categorySelect.innerHTML = "";
      uniqueValues(rawData, "categorie").forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        opt.selected = true;
        categorySelect.appendChild(opt);
      });

      vvSelect.innerHTML = "";
      uniqueValues(rawData, "vastvariabel").forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        opt.selected = true;
        vvSelect.appendChild(opt);
      });

      [yearSelect, typeSelect, categorySelect, vvSelect, topSelect].forEach(el => {
        el.addEventListener("change", applyFiltersAndUpdate);
      });
    }

    function applyFiltersAndUpdate() {
      filteredData = rawData.slice();

      const selectedYears = getSelectedValues(yearSelect).map(Number);
      if (selectedYears.length) {
        filteredData = filteredData.filter(r => selectedYears.includes(r.year));
      }

      const selectedTypes = getSelectedValues(typeSelect);
      if (selectedTypes.length) {
        filteredData = filteredData.filter(r => selectedTypes.includes(r.type));
      }

      const selectedCategories = getSelectedValues(categorySelect);
      if (selectedCategories.length) {
        filteredData = filteredData.filter(r => selectedCategories.includes(r.categorie));
      }

      const selectedVV = getSelectedValues(vvSelect);
      if (selectedVV.length) {
        filteredData = filteredData.filter(r => selectedVV.includes(r.vastvariabel));
      }

      transactionCount.textContent = filteredData.length.toString();

      updateKPIs();
      updateBalanceByMonthChart();
      updateCategoryView();
      updateMonthTable();
      updateTransactionsTable();
    }

    const kpiIncome = document.getElementById("kpiIncome");
    const kpiExpense = document.getElementById("kpiExpense");
    const kpiBalance = document.getElementById("kpiBalance");
    const kpiBalanceDelta = document.getElementById("kpiBalanceDelta");

    function updateKPIs() {
      let income = 0;
      let expense = 0;

      filteredData.forEach(r => {
        if (r.netto >= 0) income += r.netto;
        else expense += -r.netto;
      });

      const balance = income - expense;

      kpiIncome.textContent = formatEuro(income);
      kpiExpense.textContent = formatEuro(expense);
      kpiBalance.textContent = formatEuro(balance);
      kpiBalanceDelta.textContent = balance >= 0
        ? `Je houdt ${formatEuro(balance)} over in deze selectie`
        : `Je komt ${formatEuro(-balance)} tekort in deze selectie`;
    }

    function updateBalanceByMonthChart() {
      const map = new Map();
      filteredData.forEach(r => {
        if (!r.yearMonth) return;
        if (!map.has(r.yearMonth)) map.set(r.yearMonth, 0);
        map.set(r.yearMonth, map.get(r.yearMonth) + r.netto);
      });

      const labels = Array.from(map.keys()).sort();
      const values = labels.map(label => map.get(label));

      const ctx = document.getElementById("balanceByMonthChart").getContext("2d");
      if (balanceByMonthChart) balanceByMonthChart.destroy();
      balanceByMonthChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{ label: "Netto per maand", data: values }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { ticks: { callback: val => formatEuro(val) } }
          }
        }
      });
    }

    const categoryTableBody = document.querySelector("#categoryTable tbody");

    function updateCategoryView() {
      const map = new Map();
      filteredData.forEach(r => {
        const key = r.categorie || "(geen categorie)";
        if (!map.has(key)) map.set(key, 0);
        map.set(key, map.get(key) + r.netto);
      });

      let entries = Array.from(map.entries())
        .map(([categorie, netto]) => ({ categorie, netto }))
        .sort((a, b) => a.netto - b.netto);

      const topVal = topSelect.value;
      if (topVal !== "all") entries = entries.slice(0, Number(topVal));

      categoryTableBody.innerHTML = "";
      entries.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.categorie}</td><td>${formatEuro(row.netto)}</td>`;
        categoryTableBody.appendChild(tr);
      });

      const labels = entries.map(e => e.categorie);
      const values = entries.map(e => e.netto);
      const ctx = document.getElementById("byCategoryChart").getContext("2d");
      if (byCategoryChart) byCategoryChart.destroy();
      byCategoryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "Netto per categorie", data: values }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { callback: val => formatEuro(val) } }
          }
        }
      });
    }

    const monthTableBody = document.querySelector("#monthTable tbody");

    function updateMonthTable() {
      const map = new Map();
      filteredData.forEach(r => {
        if (!r.yearMonth) return;
        if (!map.has(r.yearMonth)) map.set(r.yearMonth, { income: 0, expense: 0, net: 0 });
        const obj = map.get(r.yearMonth);
        if (r.netto >= 0) obj.income += r.netto;
        else obj.expense += -r.netto;
        obj.net = obj.income - obj.expense;
      });

      const rows = Array.from(map.entries())
        .map(([ym, o]) => ({ yearMonth: ym, ...o }))
        .sort((a, b) => a.yearMonth.localeCompare(b.yearMonth));

      monthTableBody.innerHTML = "";
      rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.yearMonth}</td>
          <td>${formatEuro(row.income)}</td>
          <td>${formatEuro(row.expense)}</td>
          <td>${formatEuro(row.net)}</td>
        `;
        monthTableBody.appendChild(tr);
      });
    }

    const transactionsTableBody = document.querySelector("#transactionsTable tbody");

    function updateTransactionsTable() {
      const sorted = filteredData.slice().sort((a, b) => b.datum - a.datum);
      transactionsTableBody.innerHTML = "";
      sorted.forEach(r => {
        const typeChipClass = r.netto >= 0 ? "income" : "expense";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.datumStr}</td>
          <td><span class="chip ${typeChipClass}">${r.type}</span></td>
          <td>${r.categorie}</td>
          <td>${r.vastvariabel}</td>
          <td>${formatEuro(r.bedrag)}</td>
        `;
        transactionsTableBody.appendChild(tr);
      });
    }

    // Tabs in de sidebar
    const tabButtons = document.querySelectorAll(".sidebar-tabs .tab-button");
    const tabPanels = {
      overview: document.getElementById("tab-overview"),
      category: document.getElementById("tab-category"),
      month: document.getElementById("tab-month"),
      transactions: document.getElementById("tab-transactions")
    };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        Object.values(tabPanels).forEach(panel => panel.classList.remove("active"));
        tabPanels[tab].classList.add("active");
      });
    });

    // Start: laad automatisch de Excel
    window.addEventListener("load", loadExcelAutomatically);
  </script>
</body>
</html>

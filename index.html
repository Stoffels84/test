<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>Schadeanalyse</title>

    <!-- Excel inlezen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Grafieken voor Voertuig-tab -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="style.css">

</head>
<body>

<div class="app-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div>
            <div class="sidebar-header">
                <img src="logo.png" alt="Logo" class="site-logo">
                <div class="sidebar-title-group">
                    <div class="sidebar-title">Schadeanalyse</div>
                    <div class="sidebar-subtitle">Overzicht & rapportering</div>
                </div>
            </div>
            <div class="sidebar-section-label">Navigatie</div>
        </div>

        <nav class="sidebar-nav">
            <button class="tab-button active" data-tab="tab-all">1. Alle data</button>
            <button class="tab-button" data-tab="tab-chauffeur">2. Chauffeur</button>
            <button class="tab-button" data-tab="tab-voertuig">3. Voertuig</button>
            <button class="tab-button" data-tab="tab-locatie">4. Locatie</button>
            <button class="tab-button" data-tab="tab-dashboard">5. Dashboard</button>
            <button class="tab-button" data-tab="tab-coaching">6. Coaching</button>
            <button class="tab-button" data-tab="tab-analyse">7. Analyse</button>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-area">
        <div class="box">
            <div id="top-filters">
                <label for="year-filter">Jaar:
                    <select id="year-filter">
                        <option value="ALL">Alle jaren</option>
                    </select>
                </label>
            </div>

            <p id="status">Bezig met laden van het Excel-bestand...</p>

            <!-- TAB 1: ALLE DATA -->
            <div class="tab-content active" id="tab-all">
                <h2>Alle data (tabblad BRON)</h2>
                <p>Hier zie je alle ruwe gegevens uit het Excel-tabblad <strong>BRON</strong>. De jaarfilter bovenaan werkt op alle tabs.</p>

                <input id="search-input" type="text" placeholder="Zoeken in alle kolommen..." />

                <div class="table-container">
                    <table id="tabel">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: CHAUFFEUR -->
            <div class="tab-content" id="tab-chauffeur">
                <h2>Data rond chauffeur</h2>
                <p>Overzicht van aantal schades per chauffeur (gefilterd op gekozen jaar). Klik op een chauffeur voor details direct onder de rij.</p>

                <label for="chauffeur-limit">Toon:
                    <select id="chauffeur-limit">
                        <option value="10">Top 10</option>
                        <option value="20">Top 20</option>
                        <option value="0">Alle chauffeurs</option>
                    </select>
                </label>

                <div class="table-container">
                    <table id="chauffeur-table">
                        <thead>
                            <tr>
                                <th>Chauffeur</th>
                                <th>Aantal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 3: VOERTUIG -->
            <div class="tab-content" id="tab-voertuig">
                <h2>Data rond voertuig (Bus/Tram)</h2>
                <p>Overzicht van aantal schades per type voertuig op basis van kolom <strong>Bus/Tram</strong>. Klik op een type voor details direct onder de rij.</p>

                <label for="voertuig-limit">Toon:
                    <select id="voertuig-limit">
                        <option value="10">Top 10</option>
                        <option value="20">Top 20</option>
                        <option value="0">Alle types</option>
                    </select>
                </label>

                <div class="table-container">
                    <table id="voertuig-table">
                        <thead>
                            <tr>
                                <th>Type voertuig</th>
                                <th>Aantal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h3>Schades per maand en voertuigtype</h3>
                <p style="font-size:13px;color:#6b7280;">
                    Deze grafiek respecteert de gekozen jaarfilter bovenaan.<br>
                    X-as = maanden, kleur = voertuigtype (Bus/Tram).
                </p>
                <div class="chart-container">
                    <canvas id="voertuig-month-chart"></canvas>
                </div>
            </div>

            <!-- TAB 4: LOCATIE -->
            <div class="tab-content" id="tab-locatie">
                <h2>Data rond locatie</h2>
                <p>Overzicht van aantal schades per locatie (gefilterd op gekozen jaar). Klik op een locatie voor details direct onder de rij.</p>

                <label for="locatie-limit">Toon:
                    <select id="locatie-limit">
                        <option value="10">Top 10</option>
                        <option value="20">Top 20</option>
                        <option value="0">Alle locaties</option>
                    </select>
                </label>

                <div class="table-container">
                    <table id="locatie-table">
                        <thead>
                            <tr>
                                <th>Locatie</th>
                                <th>Aantal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 5: DASHBOARD / OPZOEKEN -->
            <div class="tab-content" id="tab-dashboard">
                <h2>Dashboard – Chauffeur opzoeken</h2>
                <p>Zoek op <strong>personeelsnummer</strong> of <strong>naam</strong>. De resultaten worden gefilterd op het geselecteerde jaar bovenaan.</p>

                <input id="dashboard-search-input" type="text" placeholder="Personeelsnr of naam..." />
                <button id="dashboard-search-button">Zoeken</button>
                <div id="dashboard-info">Tip: je kunt een deel van de naam of het nummer ingeven.</div>

                <div class="table-container" style="margin-top:10px;">
                    <div id="dashboard-coaching-summary" class="dashboard-coaching-summary"></div>

<table id="dashboard-table">
    <thead>
        <tr>
            <th>Datum</th>
            <th>Chauffeur</th>
            <th>Personeelsnr</th>
            <th>Voertuigtype</th>
            <th>Locatie</th>
            <th>Actief</th>
            <th>Link</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>


                </div>
            </div>

            <!-- TAB 6: COACHING -->
<div class="tab-content" id="tab-coaching">
    <h2>Coaching</h2>
    <div id="coaching-stats"></div>
</div>


            <!-- TAB 7: ANALYSE -->
            <div class="tab-content" id="tab-analyse">
                <h2>Analyse</h2>
                <p class="placeholder-text">
                    Wordt later uitgewerkt. Hier kun je diepere analyses doen op patronen in de data.
                </p>
            </div>
        </div>
    </main>
</div>

<script>
const statusEl = document.getElementById('status');
const table = document.getElementById('tabel');
const thead = table.querySelector('thead');
const tbody = table.querySelector('tbody');
const searchInput = document.getElementById('search-input');
const yearFilterSelect = document.getElementById('year-filter');
const dashCoachSummary = document.getElementById('dashboard-coaching-summary');

const excelFileUrl = 'schade%20met%20macro.xlsm';

// hoofddata uit schadebestand
let allHeaders = [];
let baseRows = [];
let filteredRows = [];
let dateColIndex = -1;
let chauffeurColIndex = -1;
let voertuigColIndex = -1;
let locatieColIndex = -1;
let linkColIndex = -1;
let personnelColIndex = -1;
let activeColIndex = -1;

let chauffeurData = [];
let voertuigData = [];
let locatieData = [];
let voertuigMonthChart = null;

// coachingsdata: P-nr -> array van entries { status, date, dateString }
let coachingHeaders = [];
let coachingRows = [];
const coachingMap = {};

// P-nrs die in tabblad "Coaching" staan
const coachingPendingSet = new Set();

// tabs (sidebar)
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(tc => {
            tc.classList.toggle('active', tc.id === targetId);
        });
    });
});

// zoeken in tab Alle data
searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    const rows = tbody.getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let rowMatch = false;
        for (let c = 0; c < cells.length; c++) {
            if (cells[c].textContent.toLowerCase().includes(filter)) {
                rowMatch = true;
                break;
            }
        }
        rows[i].style.display = rowMatch ? '' : 'none';
    }
});

// ---------- HULPFUNCTIES DATUM ----------

function excelSerialToDate(cell) {
    if (typeof cell === 'number') {
        const excelEpoch = Date.UTC(1899, 11, 30);
        const millis = cell * 24 * 60 * 60 * 1000;
        return new Date(excelEpoch + millis);
    }
    if (typeof cell === 'string') {
        const parts = cell.split(/[\/\-]/);
        if (parts.length === 3) {
            let [a, b, c] = parts.map(p => p.trim());
            let day, month, year;
            if (a.length === 4) {
                year = parseInt(a, 10);
                month = parseInt(b, 10);
                day = parseInt(c, 10);
            } else {
                day = parseInt(a, 10);
                month = parseInt(b, 10);
                year = parseInt(c, 10);
            }
            if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                return new Date(Date.UTC(year, month - 1, day));
            }
        }
        const d = new Date(cell);
        if (!isNaN(d)) return d;
    }
    return null;
}

function excelSerialToDateString(cell) {
    const date = excelSerialToDate(cell);
    if (!date) return cell;
    const day = String(date.getUTCDate()).padStart(2, '0');
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const year = date.getUTCFullYear();
    return `${day}/${month}/${year}`;
}

function dateToDisplayString(date) {
    if (!date || isNaN(date)) return '';
    const day = String(date.getUTCDate()).padStart(2, '0');
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const year = date.getUTCFullYear();
    return `${day}/${month}/${year}`;
}

function findColumnIndexByNames(headers, possibleNames) {
    const lower = headers.map(h => String(h).toLowerCase().trim());
    for (const name of possibleNames) {
        const idx = lower.indexOf(name.toLowerCase());
        if (idx !== -1) return idx;
    }
    return -1;
}

// ---------- HULPFUNCTIES COACHING ----------

function getCoachingStatusByText(text) {
    if (!text) return null;
    const t = String(text).toLowerCase();
    if (t.includes('zeer goed') || t.trim() === 'goed' || t.includes(' goed')) return 'good';
    if (t.includes('voldoende') || t.includes('onvoldoende')) return 'medium';
    if (t.includes('slecht')) return 'bad';
    return null;
}

function getCoachingEntriesForPnr(pnr) {
    if (pnr === null || pnr === undefined) return [];
    const key = String(pnr).trim();
    if (!key) return [];
    return coachingMap[key] || [];
}

function getCoachingStatusesForPnr(pnr) {
    return getCoachingEntriesForPnr(pnr).map(e => e.status);
}

function getPrimaryCoachingStatusForPnr(pnr) {
    const list = getCoachingStatusesForPnr(pnr);
    if (!list.length) return null;
    if (list.includes('bad')) return 'bad';
    if (list.includes('medium')) return 'medium';
    if (list.includes('good')) return 'good';
    return null;
}

function getLatestCoachingForPnr(pnr) {
    const entries = getCoachingEntriesForPnr(pnr);
    if (!entries.length) return null;
    let latest = entries[0];
    let latestTime = latest.date ? latest.date.getTime() : 0;
    entries.forEach(e => {
        if (!e.date) return;
        const t = e.date.getTime();
        if (t > latestTime) {
            latestTime = t;
            latest = e;
        }
    });
    return latest;
}

function isInCoachingList(pnr) {
    if (pnr === null || pnr === undefined) return false;
    const key = String(pnr).trim();
    if (!key) return false;
    return coachingPendingSet.has(key);
}

// ---------- JAARFILTER ----------

function populateYearFilter() {
    yearFilterSelect.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'ALL';
    optAll.textContent = 'Alle jaren';
    yearFilterSelect.appendChild(optAll);

    if (dateColIndex === -1) return;

    const yearSet = new Set();
    baseRows.forEach(row => {
        const d = excelSerialToDate(row[dateColIndex]);
        if (d) yearSet.add(d.getUTCFullYear());
    });

    const years = Array.from(yearSet).sort((a, b) => a - b);
    years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = y;
        yearFilterSelect.appendChild(opt);
    });
}

function getFilteredRows() {
    if (dateColIndex === -1) return baseRows;
    const value = yearFilterSelect.value;
    if (!value || value === 'ALL') return baseRows;
    const yearInt = parseInt(value, 10);
    if (isNaN(yearInt)) return baseRows;
    return baseRows.filter(row => {
        const d = excelSerialToDate(row[dateColIndex]);
        return d && d.getUTCFullYear() === yearInt;
    });
}

// ---------- CEL MAKEN (link + coachingbollen) ----------

function createCell(idx, row) {
    const rawValue = row[idx];
    let value = rawValue;
    if (idx === dateColIndex) {
        value = excelSerialToDateString(rawValue);
    }
    const td = document.createElement('td');

    const pnrVal = (personnelColIndex !== -1) ? row[personnelColIndex] : null;
    const status = getPrimaryCoachingStatusForPnr(pnrVal);
    const inCoachingList = isInCoachingList(pnrVal);

    if (idx === linkColIndex && value) {
        const href = String(value).trim();
        const a = document.createElement('a');
        a.href = href;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'table-link';
        a.textContent = '=> naar EAF';
        td.appendChild(a);
        return td;
    }

    if (idx === chauffeurColIndex) {
        const wrapper = document.createElement('span');
        wrapper.style.display = 'inline-flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '6px';

        if (inCoachingList) {
            const blackDot = document.createElement('span');
            blackDot.classList.add('coaching-dot', 'coaching-pending');
            blackDot.title = 'In Coaching-lijst';
            wrapper.appendChild(blackDot);
        }

        if (status) {
            const dot = document.createElement('span');
            dot.classList.add('coaching-dot');
            if (status === 'good')   dot.classList.add('coaching-good');
            if (status === 'medium') dot.classList.add('coaching-medium');
            if (status === 'bad')    dot.classList.add('coaching-bad');
            dot.title = 'Coachingstatus';
            wrapper.appendChild(dot);
        }

        const nameSpan = document.createElement('span');
        nameSpan.textContent = (value === null || value === undefined) ? '' : value;
        wrapper.appendChild(nameSpan);
        td.appendChild(wrapper);
        return td;
    }

    if (idx === personnelColIndex) {
        const wrapper = document.createElement('span');
        wrapper.style.display = 'inline-flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '6px';

        const numSpan = document.createElement('span');
        numSpan.textContent = (value === null || value === undefined) ? '' : value;
        wrapper.appendChild(numSpan);

        if (inCoachingList) {
            const blackDot = document.createElement('span');
            blackDot.classList.add('coaching-dot', 'coaching-pending');
            blackDot.title = 'In Coaching-lijst';
            wrapper.appendChild(blackDot);
        }

        if (status) {
            const dot = document.createElement('span');
            dot.classList.add('coaching-dot');
            if (status === 'good')   dot.classList.add('coaching-good');
            if (status === 'medium') dot.classList.add('coaching-medium');
            if (status === 'bad')    dot.classList.add('coaching-bad');
            dot.title = 'Coachingstatus';
            wrapper.appendChild(dot);
        }

        td.appendChild(wrapper);
        return td;
    }

    td.textContent = (value === null || value === undefined) ? '' : value;
    return td;
}

// ---------- TABEL ALLE DATA ----------

function rebuildAllDataTableBody(rows) {
    tbody.innerHTML = '';
    rows.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((_, idx) => {
            const td = createCell(idx, row);
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

// ---------- AGGREGATIES ----------

function buildChauffeurData(rows) {
    chauffeurData = [];
    if (chauffeurColIndex === -1) return;
    const map = new Map();
    rows.forEach(row => {
        let name = row[chauffeurColIndex];
        name = (name && String(name).trim() !== '') ? String(name).trim() : 'Onbekend';
        if (!map.has(name)) {
            map.set(name, { name: name, count: 0, rows: [] });
        }
        const entry = map.get(name);
        entry.count++;
        entry.rows.push(row);
    });
    chauffeurData = Array.from(map.values()).sort((a, b) => b.count - a.count);
}

function buildVoertuigData(rows) {
    voertuigData = [];
    if (voertuigColIndex === -1) return;
    const map = new Map();
    rows.forEach(row => {
        let type = row[voertuigColIndex];
        type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';
        if (!map.has(type)) {
            map.set(type, { type: type, count: 0, rows: [] });
        }
        const entry = map.get(type);
        entry.count++;
        entry.rows.push(row);
    });
    voertuigData = Array.from(map.values()).sort((a, b) => b.count - a.count);
}

function buildLocatieData(rows) {
    locatieData = [];
    if (locatieColIndex === -1) return;
    const map = new Map();
    rows.forEach(row => {
        let loc = row[locatieColIndex];
        loc = (loc && String(loc).trim() !== '') ? String(loc).trim() : 'Onbekend';
        if (!map.has(loc)) {
            map.set(loc, { locatie: loc, count: 0, rows: [] });
        }
        const entry = map.get(loc);
        entry.count++;
        entry.rows.push(row);
    });
    locatieData = Array.from(map.values()).sort((a, b) => b.count - a.count);
}

// ---------- DETAILTABELLEN (chauffeur/voertuig/locatie) ----------

function showChauffeurDetailsInline(name, clickedRow) {
    const tbodyCh = document.querySelector('#chauffeur-table tbody');
    const nextRow = clickedRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('chauffeur-detail-row')) {
        nextRow.remove();
        return;
    }
    Array.from(tbodyCh.querySelectorAll('.chauffeur-detail-row')).forEach(r => r.remove());

    const entry = chauffeurData.find(c => c.name === name);
    if (!entry) return;

    const headers = allHeaders;
    const cols = [];
    const addCol = (possibleNames) => {
        const idx = findColumnIndexByNames(headers, possibleNames);
        if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
    };
    if (chauffeurColIndex !== -1) cols.push(chauffeurColIndex);
    addCol(['datum']);
    addCol(['locatie']);
    addCol(['bus/ tram', 'bus/tram']);
    addCol(['link']);
    addCol(['personeelsnr', 'personeelsnummer', 'personeels nr', 'p-nr', 'p nr']);

    const detailTr = document.createElement('tr');
    detailTr.className = 'chauffeur-detail-row';
    const detailTd = document.createElement('td');
    detailTd.colSpan = 2;

    const innerTable = document.createElement('table');
    innerTable.style.width = '100%';
    innerTable.style.fontSize = '12px';

    const theadInner = document.createElement('thead');
    const hr = document.createElement('tr');
    cols.forEach(idx => {
        const th = document.createElement('th');
        th.textContent = headers[idx];
        hr.appendChild(th);
    });
    theadInner.appendChild(hr);

    const tbodyInner = document.createElement('tbody');
    entry.rows.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(idx => {
            const td = createCell(idx, row);
            tr.appendChild(td);
        });
        tbodyInner.appendChild(tr);
    });

    innerTable.appendChild(theadInner);
    innerTable.appendChild(tbodyInner);
    detailTd.appendChild(innerTable);
    detailTr.appendChild(detailTd);
    clickedRow.insertAdjacentElement('afterend', detailTr);
}

function showVoertuigDetailsInline(type, clickedRow) {
    const tbodyV = document.querySelector('#voertuig-table tbody');
    const nextRow = clickedRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('voertuig-detail-row')) {
        nextRow.remove();
        return;
    }
    Array.from(tbodyV.querySelectorAll('.voertuig-detail-row')).forEach(r => r.remove());

    const entry = voertuigData.find(v => v.type === type);
    if (!entry) return;

    const headers = allHeaders;
    const cols = [];
    const addCol = (possibleNames) => {
        const idx = findColumnIndexByNames(headers, possibleNames);
        if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
    };
    if (voertuigColIndex !== -1) cols.push(voertuigColIndex);
    addCol(['volledige naam', 'chauffeur', 'naam', 'bestuurder']);
    addCol(['datum']);
    addCol(['locatie']);
    addCol(['link']);
    addCol(['personeelsnr', 'personeelsnummer', 'personeels nr', 'p-nr', 'p nr']);

    const detailTr = document.createElement('tr');
    detailTr.className = 'voertuig-detail-row';
    const detailTd = document.createElement('td');
    detailTd.colSpan = 2;

    const innerTable = document.createElement('table');
    innerTable.style.width = '100%';
    innerTable.style.fontSize = '12px';

    const theadInner = document.createElement('thead');
    const hr = document.createElement('tr');
    cols.forEach(idx => {
        const th = document.createElement('th');
        th.textContent = headers[idx];
        hr.appendChild(th);
    });
    theadInner.appendChild(hr);

    const tbodyInner = document.createElement('tbody');
    entry.rows.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(idx => {
            const td = createCell(idx, row);
            tr.appendChild(td);
        });
        tbodyInner.appendChild(tr);
    });

    innerTable.appendChild(theadInner);
    innerTable.appendChild(tbodyInner);
    detailTd.appendChild(innerTable);
    detailTr.appendChild(detailTd);
    clickedRow.insertAdjacentElement('afterend', detailTr);
}

function showLocatieDetailsInline(loc, clickedRow) {
    const tbodyL = document.querySelector('#locatie-table tbody');
    const nextRow = clickedRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('locatie-detail-row')) {
        nextRow.remove();
        return;
    }
    Array.from(tbodyL.querySelectorAll('.locatie-detail-row')).forEach(r => r.remove());

    const entry = locatieData.find(l => l.locatie === loc);
    if (!entry) return;

    const headers = allHeaders;
    const cols = [];
    const addCol = (possibleNames) => {
        const idx = findColumnIndexByNames(headers, possibleNames);
        if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
    };
    if (locatieColIndex !== -1) cols.push(locatieColIndex);
    addCol(['volledige naam', 'chauffeur', 'naam', 'bestuurder']);
    addCol(['datum']);
    addCol(['bus/ tram', 'bus/tram']);
    addCol(['link']);
    addCol(['personeelsnr', 'personeelsnummer', 'personeels nr', 'p-nr', 'p nr']);

    const detailTr = document.createElement('tr');
    detailTr.className = 'locatie-detail-row';
    const detailTd = document.createElement('td');
    detailTd.colSpan = 2;

    const innerTable = document.createElement('table');
    innerTable.style.width = '100%';
    innerTable.style.fontSize = '12px';

    const theadInner = document.createElement('thead');
    const hr = document.createElement('tr');
    cols.forEach(idx => {
        const th = document.createElement('th');
        th.textContent = headers[idx];
        hr.appendChild(th);
    });
    theadInner.appendChild(hr);

    const tbodyInner = document.createElement('tbody');
    entry.rows.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(idx => {
            const td = createCell(idx, row);
            tr.appendChild(td);
        });
        tbodyInner.appendChild(tr);
    });

    innerTable.appendChild(theadInner);
    innerTable.appendChild(tbodyInner);
    detailTd.appendChild(innerTable);
    detailTr.appendChild(detailTd);
    clickedRow.insertAdjacentElement('afterend', detailTr);
}

// ---------- OVERZICHTSTABELLEN (chauffeur/voertuig/locatie) ----------

function updateChauffeurView() {
    const limitSelect = document.getElementById('chauffeur-limit');
    const tbodyCh = document.querySelector('#chauffeur-table tbody');
    tbodyCh.innerHTML = '';
    let limit = parseInt(limitSelect.value, 10);
    if (isNaN(limit) || limit < 0) limit = 10;
    const list = (limit === 0) ? chauffeurData : chauffeurData.slice(0, limit);
    list.forEach(ch => {
        const tr = document.createElement('tr');
        tr.dataset.chauffeur = ch.name;

        const tdName = document.createElement('td');
        const wrapper = document.createElement('span');
        wrapper.style.display = 'inline-flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.gap = '4px';

        let statuses = [];
        let inCoachingList = false;

        if (personnelColIndex !== -1 && ch.rows.length > 0) {
            const pnrVal = ch.rows[0][personnelColIndex];
            statuses = getCoachingStatusesForPnr(pnrVal);
            inCoachingList = isInCoachingList(pnrVal);
        }

        if (inCoachingList) {
            const blackDot = document.createElement('span');
            blackDot.classList.add('coaching-dot', 'coaching-pending');
            blackDot.title = 'In Coaching-lijst';
            wrapper.appendChild(blackDot);
        }

        statuses.forEach(st => {
            const dot = document.createElement('span');
            dot.classList.add('coaching-dot');
            if (st === 'good')   dot.classList.add('coaching-good');
            if (st === 'medium') dot.classList.add('coaching-medium');
            if (st === 'bad')    dot.classList.add('coaching-bad');
            dot.title = 'Coachingstatus';
            wrapper.appendChild(dot);
        });

        const nameSpan = document.createElement('span');
        nameSpan.textContent = ch.name;
        wrapper.appendChild(nameSpan);
        tdName.appendChild(wrapper);

        const tdCount = document.createElement('td');
        tdCount.textContent = ch.count;

        tr.appendChild(tdName);
        tr.appendChild(tdCount);
        tr.addEventListener('click', () => showChauffeurDetailsInline(ch.name, tr));
        tbodyCh.appendChild(tr);
    });
}

function updateVoertuigView() {
    const limitSelect = document.getElementById('voertuig-limit');
    const tbodyV = document.querySelector('#voertuig-table tbody');
    tbodyV.innerHTML = '';
    let limit = parseInt(limitSelect.value, 10);
    if (isNaN(limit) || limit < 0) limit = 10;
    const list = (limit === 0) ? voertuigData : voertuigData.slice(0, limit);
    list.forEach(v => {
        const tr = document.createElement('tr');
        tr.dataset.type = v.type;
        const tdType = document.createElement('td');
        tdType.textContent = v.type;
        const tdCount = document.createElement('td');
        tdCount.textContent = v.count;
        tr.appendChild(tdType);
        tr.appendChild(tdCount);
        tr.addEventListener('click', () => showVoertuigDetailsInline(v.type, tr));
        tbodyV.appendChild(tr);
    });
}

function updateLocatieView() {
    const limitSelect = document.getElementById('locatie-limit');
    const tbodyL = document.querySelector('#locatie-table tbody');
    tbodyL.innerHTML = '';
    let limit = parseInt(limitSelect.value, 10);
    if (isNaN(limit) || limit < 0) limit = 10;
    const list = (limit === 0) ? locatieData : locatieData.slice(0, limit);
    list.forEach(l => {
        const tr = document.createElement('tr');
        tr.dataset.locatie = l.locatie;
        const tdLoc = document.createElement('td');
        tdLoc.textContent = l.locatie;
        const tdCount = document.createElement('td');
        tdCount.textContent = l.count;
        tr.appendChild(tdLoc);
        tr.appendChild(tdCount);
        tr.addEventListener('click', () => showLocatieDetailsInline(l.locatie, tr));
        tbodyL.appendChild(tr);
    });
}

// ---------- GRAFIEK VOERTUIG ----------

function buildVoertuigMonthChart(rows) {
    const canvas = document.getElementById('voertuig-month-chart');
    if (!canvas || voertuigColIndex === -1 || dateColIndex === -1) return;
    const ctx = canvas.getContext('2d');

    if (voertuigMonthChart) {
        voertuigMonthChart.destroy();
    }

    const monthLabels = ['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];

    const typeSet = new Set();
    rows.forEach(row => {
        let type = row[voertuigColIndex];
        type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';
        typeSet.add(type);
    });
    const types = Array.from(typeSet).sort();

    const dataByType = {};
    types.forEach(t => { dataByType[t] = new Array(12).fill(0); });

    rows.forEach(row => {
        const d = excelSerialToDate(row[dateColIndex]);
        if (!d) return;
        let type = row[voertuigColIndex];
        type = (type && String(type).trim() !== '') ? String(type).trim() : 'Onbekend';
        if (!dataByType[type]) dataByType[type] = new Array(12).fill(0);
        const m = d.getUTCMonth();
        dataByType[type][m] += 1;
    });

    const datasets = types.map(t => ({
        label: t,
        data: dataByType[t]
    }));

    voertuigMonthChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
}

// ---------- DASHBOARD: COACHINGS-BLOK BOVEN TABEL ----------

function renderDashboardCoachingSummary(results) {
    dashCoachSummary.innerHTML = '';

    if (!results.length || personnelColIndex === -1) return;

    const first = results[0];
    const pnr = first[personnelColIndex];
    const name = (chauffeurColIndex !== -1 && first[chauffeurColIndex]) ? String(first[chauffeurColIndex]) : '';
    const entries = getCoachingEntriesForPnr(pnr);

    if (!entries.length) {
        dashCoachSummary.innerHTML = `<p>Geen coachings gevonden voor P-nr ${pnr || ''}.</p>`;
        return;
    }

    entries.sort((a, b) => {
        if (!a.date || !b.date) return 0;
        return a.date - b.date;
    });

    let html = `<div class="dashboard-coaching-box">
        <div class="dashboard-coaching-title">
            Coachings voor <strong>${pnr || ''}</strong>${name ? ' – ' + name : ''}
        </div>
        <div class="dashboard-coaching-list">`;

    entries.forEach(e => {
        let dotClass = '';
        if (e.status === 'good') dotClass = 'coaching-good';
        if (e.status === 'medium') dotClass = 'coaching-medium';
        if (e.status === 'bad') dotClass = 'coaching-bad';

        html += `
            <div class="dashboard-coaching-item">
                <span class="dashboard-coaching-date">${e.dateString || ''}</span>
                <span class="coaching-dot ${dotClass}"></span>
            </div>`;
    });

    html += `</div></div>`;
    dashCoachSummary.innerHTML = html;
}

// ---------- DASHBOARD ZOEKEN ----------

function searchDashboard() {
    const input = document.getElementById('dashboard-search-input');
    const term = input.value.trim().toLowerCase();
    const tbodyDash = document.querySelector('#dashboard-table tbody');
    tbodyDash.innerHTML = '';
    dashCoachSummary.innerHTML = '';

    if (!term) return;

    const rows = filteredRows;
    const results = [];

    rows.forEach(row => {
        const nameVal = (chauffeurColIndex !== -1 && row[chauffeurColIndex]) ?
            String(row[chauffeurColIndex]).toLowerCase() : '';
        const persVal = (personnelColIndex !== -1 && row[personnelColIndex]) ?
            String(row[personnelColIndex]).toLowerCase() : '';
        if (nameVal.includes(term) || persVal.includes(term)) {
            results.push(row);
        }
    });

    if (results.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.textContent = 'Geen resultaten gevonden voor deze zoekopdracht (binnen de gekozen jaarfilter).';
        tr.appendChild(td);
        tbodyDash.appendChild(tr);
        return;
    }

    renderDashboardCoachingSummary(results);

    const cols = [];
    if (dateColIndex !== -1) cols.push(dateColIndex);
    if (chauffeurColIndex !== -1) cols.push(chauffeurColIndex);
    if (personnelColIndex !== -1) cols.push(personnelColIndex);
    if (voertuigColIndex !== -1) cols.push(voertuigColIndex);
    if (locatieColIndex !== -1) cols.push(locatieColIndex);
    if (activeColIndex !== -1) cols.push(activeColIndex);
    if (linkColIndex !== -1) cols.push(linkColIndex);

    results.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(idx => {
            const td = createCell(idx, row);
            tr.appendChild(td);
        });
        tbodyDash.appendChild(tr);
    });
}

// ---------- ANALYSE FUNCTIES (voor tab Coaching) ----------

function getPnrSetFromFilteredRows() {
    const set = new Set();
    if (personnelColIndex === -1) return set;
    filteredRows.forEach(row => {
        const p = row[personnelColIndex];
        if (!p) return;
        const key = String(p).trim();
        if (key) set.add(key);
    });
    return set;
}

function countPnrInCoaching() {
    const pnrSetYear = getPnrSetFromFilteredRows();
    return Array.from(coachingPendingSet).filter(p => pnrSetYear.has(p)).length;
}

function countPnrInVoltooide() {
    const pnrSetYear = getPnrSetFromFilteredRows();
    return Object.keys(coachingMap).filter(p => pnrSetYear.has(p)).length;
}

function countUniquePnrInVoltooide() {
    return countPnrInVoltooide();
}

function findHighDamageWithoutCoaching() {
    if (personnelColIndex === -1) return [];

    const teller = new Map();

    // gebruik alleen gefilterde rijen (jaarfilter)
    filteredRows.forEach(row => {
        const p = row[personnelColIndex];
        if (!p) return;
        const key = String(p).trim();
        if (!key) return;

        let name = '';
        if (chauffeurColIndex !== -1 && row[chauffeurColIndex]) {
            name = String(row[chauffeurColIndex]).trim();
        }

        if (!teller.has(key)) {
            teller.set(key, { count: 0, name: name });
        }
        const info = teller.get(key);
        info.count += 1;
        if (!info.name && name) {
            info.name = name;
        }
    });

    const resultaat = [];

    teller.forEach((info, pnr) => {
        if (
            info.count > 2 &&
            !coachingMap[pnr] &&
            !coachingPendingSet.has(pnr)
        ) {
            resultaat.push({
                pnr: pnr,
                naam: info.name || '',
                aantal: info.count
            });
        }
    });

    return resultaat;
}

function listPnrInCoaching() {
    return Array.from(coachingPendingSet).sort();
}

function updateCoachingStats() {
    const div = document.getElementById('coaching-stats');
    if (!div) return;

    const pnrSetYear = getPnrSetFromFilteredRows();

    const pCoaching = Array.from(coachingPendingSet)
        .filter(p => pnrSetYear.has(p)).length;

    const pVoltooide = Object.keys(coachingMap)
        .filter(p => pnrSetYear.has(p)).length;

    const pVoltooideUniek = pVoltooide;

    const highDamage = findHighDamageWithoutCoaching();

    const coachingListFiltered = listPnrInCoaching()
        .filter(p => pnrSetYear.has(p));

    let html = `
        <h3>Coaching overzicht</h3>
        <ul>
            <li><strong>Aantal P-nrs in tabblad "Coaching" (jaarfilter):</strong> ${pCoaching}</li>
            <li><strong>Aantal P-nrs in "Voltooide coachings" (jaarfilter):</strong> ${pVoltooide}</li>
            <li><strong>Unieke P-nrs in "Voltooide coachings" (jaarfilter):</strong> ${pVoltooideUniek}</li>
            <li><strong>P-nrs &gt; 2 schades zonder coaching (jaarfilter):</strong> ${highDamage.length}</li>
        </ul>
    `;

    if (highDamage.length > 0) {
        html += `<h4>P-nrs met &gt; 2 schades en geen coaching (jaarfilter):</h4>`;
        html += `<ul>`;
        highDamage.forEach(e => {
            const naam = e.naam ? ` — ${e.naam}` : '';
            html += `<li>${e.pnr}${naam} — ${e.aantal} schades</li>`;
        });
        html += `</ul>`;
    }

    // lijst weglaten op verzoek
    }

    div.innerHTML = html;
}

// ---------- ALLES HERAUFBOUWEN ----------

function updateFilterAndViews() {
    if (!baseRows.length) return;
    filteredRows = getFilteredRows();
    rebuildAllDataTableBody(filteredRows);
    buildChauffeurData(filteredRows);
    buildVoertuigData(filteredRows);
    buildLocatieData(filteredRows);
    updateChauffeurView();
    updateVoertuigView();
    updateLocatieView();
    buildVoertuigMonthChart(filteredRows);
    searchDashboard();

    const filterText = (yearFilterSelect.value === 'ALL'
        ? 'alle jaren'
        : 'jaar ' + yearFilterSelect.value);
    const coachingCount = Object.keys(coachingMap).length;
    statusEl.textContent = 'Klaar. ' + filteredRows.length +
        ' rijen geladen (' + filterText + '). Coachings voor ' +
        coachingCount + ' P-nrs geladen.';
}

// ---------- EVENT LISTENERS ----------

document.getElementById('chauffeur-limit').addEventListener('change', updateChauffeurView);
document.getElementById('voertuig-limit').addEventListener('change', updateVoertuigView);
document.getElementById('locatie-limit').addEventListener('change', updateLocatieView);
yearFilterSelect.addEventListener('change', updateFilterAndViews);

document.getElementById('dashboard-search-button').addEventListener('click', searchDashboard);
document.getElementById('dashboard-search-input').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') searchDashboard();
});

// ---------- 1) HOOFD-EXCEL LADEN ----------

fetch(excelFileUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('Kon het Excel-bestand niet laden (HTTP ' + response.status + ')');
        }
        return response.arrayBuffer();
    })
    .then(data => {
        statusEl.textContent = 'Excel-bestand geladen, bezig met verwerken...';

        const uint8 = new Uint8Array(data);
        const workbook = XLSX.read(uint8, { type: 'array' });

        const sheetName = 'BRON';
        if (!workbook.SheetNames.includes(sheetName)) {
            statusEl.textContent = "Tabblad 'BRON' bestaat niet in het Excel-bestand!";
            return;
        }

        const worksheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (!rows || rows.length === 0) {
            statusEl.textContent = 'Geen data gevonden in tabblad BRON.';
            return;
        }

        allHeaders = rows[0];
        baseRows = rows.slice(1);

        thead.innerHTML = '';
        const headerRow = document.createElement('tr');
        allHeaders.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        dateColIndex = findColumnIndexByNames(allHeaders, ['datum']);
        chauffeurColIndex = findColumnIndexByNames(allHeaders, ['volledige naam', 'chauffeur', 'naam', 'bestuurder']);
        voertuigColIndex = findColumnIndexByNames(allHeaders, ['bus/tram', 'bus/ tram']);
        locatieColIndex = findColumnIndexByNames(allHeaders, ['locatie']);
        linkColIndex = findColumnIndexByNames(allHeaders, ['link']);
        personnelColIndex = findColumnIndexByNames(allHeaders, ['personeelsnr', 'personeelsnummer', 'personeels nr', 'p-nr', 'p nr']);
        activeColIndex = findColumnIndexByNames(allHeaders, ['actief', 'active']);

        populateYearFilter();
        updateFilterAndViews();
    })
    .catch(err => {
        console.error(err);
        statusEl.textContent = 'Er ging iets mis bij het laden of verwerken van het Excel-bestand.';
    });

// ---------- 2) COACHINGSLIJST LADEN ----------

fetch('Coachingslijst.xlsx')
    .then(response => {
        if (!response.ok) {
            throw new Error('Kon Coachingslijst.xlsx niet laden (HTTP ' + response.status + ')');
        }
        return response.arrayBuffer();
    })
    .then(data => {
        const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });

        const sheetDoneName = 'Voltooide coachings';
        const sheetPendingName = 'Coaching';

        const sheetDone = workbook.Sheets[sheetDoneName];
        const sheetPending = workbook.Sheets[sheetPendingName];

        // --- Voltooide coachings ---
        if (sheetDone) {
            const rowsDone = XLSX.utils.sheet_to_json(sheetDone, { header: 1 });

            if (rowsDone.length) {
                coachingHeaders = rowsDone[0];
                coachingRows = rowsDone.slice(1);

                const pIndex = coachingHeaders.indexOf('P-nr');
                const ratingIndex = coachingHeaders.indexOf('Beoordeling coaching');
                const dateIndex = findColumnIndexByNames(coachingHeaders, ['datum', 'datum coaching']);

                if (pIndex === -1 || ratingIndex === -1) {
                    console.warn('Kolommen P-nr / Beoordeling coaching niet gevonden in Voltooide coachings.');
                } else {
                    coachingRows.forEach(row => {
                        const p = row[pIndex];
                        const rating = row[ratingIndex];
                        const status = getCoachingStatusByText(rating);
                        if (!p || !status) return;

                        let dateObj = null;
                        let dateString = '';
                        if (dateIndex !== -1) {
                            const rawDate = row[dateIndex];
                            dateObj = excelSerialToDate(rawDate);
                            dateString = dateToDisplayString(dateObj);
                        }

                        const key = String(p).trim();
                        if (!coachingMap[key]) {
                            coachingMap[key] = [];
                        }
                        coachingMap[key].push({
                            status: status,
                            date: dateObj,
                            dateString: dateString
                        });
                    });
                }
            }
        } else {
            console.warn("Tabblad 'Voltooide coachings' niet gevonden in Coachingslijst.xlsx");
        }

        // --- Coaching-tab: P-nr staat in kolom D (via echte cellen) ---
        if (sheetPending) {
            coachingPendingSet.clear();

            const range = XLSX.utils.decode_range(sheetPending['!ref']);

            for (let r = range.s.r + 1; r <= range.e.r; r++) { // vanaf tweede rij (na header)
                const cellRef = XLSX.utils.encode_cell({ c: 3, r: r }); // c=3 => kolom D
                const cell = sheetPending[cellRef];
                if (!cell || cell.v == null || cell.v === '') continue;

                const key = String(cell.v).trim();
                if (key !== '') {
                    coachingPendingSet.add(key);
                }
            }
        } else {
            console.warn("Tabblad 'Coaching' niet gevonden in Coachingslijst.xlsx");
        }

        console.log('CoachingMap:', coachingMap);
        console.log('CoachingPendingSet:', coachingPendingSet);

        updateFilterAndViews();
        updateCoachingStats();
    })
    .catch(err => {
        console.error('Fout bij Coachingslijst:', err);
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <title>Schadeanalyse</title>

    <!-- Excel inlezen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Grafieken -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
        }
        .box {
            padding: 30px 40px;
            background: white;
            border-radius: 0;
            width: 100%;
            max-width: 100%;
            margin: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        #status {
            margin-top: 5px;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-bottom: none;
            background: #f7f7f7;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
        }
        .tab-button.active {
            background: white;
            font-weight: bold;
            border-bottom: 1px solid white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Tabel layout */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
            table-layout: auto;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }
        th {
            background: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Zoekveld */
        #search-input {
            padding: 8px;
            width: 300px;
            max-width: 100%;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .placeholder-text {
            color: #777;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Chauffeur tab specifieke dingen */
        #chauffeur-limit {
            padding: 6px;
            font-size: 13px;
            margin-left: 5px;
        }
        #chauffeur-table tbody tr {
            cursor: pointer;
        }
        #chauffeur-table tbody tr:hover {
            background: #f5f5f5;
        }
        #chauffeur-selected {
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 5px;
            color: #333;
        }
        .chart-container {
            margin-top: 20px;
            height: 260px;
        }
    </style>
</head>
<body>

<div class="box">
    <h1>Schadeanalyse</h1>
    <p id="status">Bezig met laden van het Excel-bestand...</p>

    <!-- TAB KNOPPEN -->
    <div class="tabs">
        <button class="tab-button active" data-tab="tab-all">1. Alle data</button>
        <button class="tab-button" data-tab="tab-chauffeur">2. Chauffeur</button>
        <button class="tab-button" data-tab="tab-voertuig">3. Voertuig</button>
        <button class="tab-button" data-tab="tab-locatie">4. Locatie</button>
        <button class="tab-button" data-tab="tab-dashboard">5. Dashboard</button>
        <button class="tab-button" data-tab="tab-coaching">6. Coaching</button>
        <button class="tab-button" data-tab="tab-analyse">7. Analyse</button>
    </div>

    <!-- TAB 1: ALLE DATA (BRON) -->
    <div class="tab-content active" id="tab-all">
        <h2>Alle data (tabblad BRON)</h2>
        <p>Hier zie je alle ruwe gegevens uit het Excel-tabblad <strong>BRON</strong>.</p>

        <input id="search-input" type="text" placeholder="Zoeken in alle kolommen..." />

        <div class="table-container">
            <table id="tabel">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 2: CHAUFFEUR -->
    <div class="tab-content" id="tab-chauffeur">
        <h2>Data rond chauffeur</h2>
        <p>Overzicht van aantal schades per chauffeur. Klik op een chauffeur voor details.</p>

        <label for="chauffeur-limit">Toon:
            <select id="chauffeur-limit">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="0">Alle chauffeurs</option>
            </select>
        </label>

        <div class="table-container">
            <table id="chauffeur-table">
                <thead>
                    <tr>
                        <th>Chauffeur</th>
                        <th>Aantal schades</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>Details gekozen chauffeur</h3>
        <p id="chauffeur-selected">Klik op een chauffeur in de tabel hierboven.</p>

        <div class="table-container">
            <table id="chauffeur-detail-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <h3>Grafiek: schades per chauffeur</h3>
        <div class="chart-container">
            <canvas id="chauffeur-chart"></canvas>
        </div>
    </div>

    <!-- TAB 3: VOERTUIG -->
    <div class="tab-content" id="tab-voertuig">
        <h2>Data rond voertuig</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Hier kun je bv. per bus/tram het aantal schades tonen.
        </p>
    </div>

    <!-- TAB 4: LOCATIE -->
    <div class="tab-content" id="tab-locatie">
        <h2>Data rond locatie</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Hier kun je bv. per locatie een overzicht maken.
        </p>
    </div>

    <!-- TAB 5: DASHBOARD -->
    <div class="tab-content" id="tab-dashboard">
        <h2>Dashboard</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Hier kunnen samenvattende grafieken en KPI's komen.
        </p>
    </div>

    <!-- TAB 6: COACHING -->
    <div class="tab-content" id="tab-coaching">
        <h2>Coaching</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Bijvoorbeeld overzicht van coaching-acties per chauffeur.
        </p>
    </div>

    <!-- TAB 7: ANALYSE -->
    <div class="tab-content" id="tab-analyse">
        <h2>Analyse</h2>
        <p class="placeholder-text">
            Wordt later uitgewerkt. Hier kun je diepere analyses doen op patronen in de data.
        </p>
    </div>

</div>

<script>
    const statusEl = document.getElementById('status');
    const table = document.getElementById('tabel');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const searchInput = document.getElementById('search-input');

    const excelFileUrl = 'schade%20met%20macro.xlsm';

    // globale data
    let allHeaders = [];
    let allRows = [];
    let dateColIndex = -1;
    let chauffeurColIndex = -1;
    let chauffeurData = [];
    let chauffeurChart = null;

    // ---- Tabs ----
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-tab');

            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            tabContents.forEach(tc => {
                if (tc.id === targetId) {
                    tc.classList.add('active');
                } else {
                    tc.classList.remove('active');
                }
            });
        });
    });

    // ---- Zoekfunctie Alle data ----
    searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toLowerCase();
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let rowMatch = false;

            for (let c = 0; c < cells.length; c++) {
                if (cells[c].textContent.toLowerCase().includes(filter)) {
                    rowMatch = true;
                    break;
                }
            }

            rows[i].style.display = rowMatch ? '' : 'none';
        }
    });

    // ---- Excel-seriedatum -> dd/mm/jjjj ----
    function excelSerialToDateString(serial) {
        if (typeof serial !== 'number') return serial;
        const excelEpoch = Date.UTC(1899, 11, 30); // 30 dec 1899
        const millis = serial * 24 * 60 * 60 * 1000;
        const date = new Date(excelEpoch + millis);

        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();

        return `${day}/${month}/${year}`;
    }

    // ---- Helper: kolomindex zoeken op naam ----
    function findColumnIndexByNames(headers, possibleNames) {
        const lower = headers.map(h => String(h).toLowerCase().trim());
        for (const name of possibleNames) {
            const idx = lower.indexOf(name.toLowerCase());
            if (idx !== -1) return idx;
        }
        return -1;
    }

    // ---- Alle data tabel vullen + globale data opslaan ----
    function buildAllDataTable(rows) {
        allHeaders = rows[0];
        allRows = rows.slice(1);

        // header
        const headerRow = document.createElement('tr');
        allHeaders.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // kolom-indexen zoeken
        dateColIndex = findColumnIndexByNames(allHeaders, ['datum']);
        chauffeurColIndex = findColumnIndexByNames(allHeaders, ['volledige naam', 'chauffeur', 'naam', 'bestuurder']);

        // body
        allRows.forEach(r => {
            const tr = document.createElement('tr');

            r.forEach((cell, idx) => {
                let value = cell;
                if (idx === dateColIndex && typeof cell === 'number') {
                    value = excelSerialToDateString(cell);
                }
                const td = document.createElement('td');
                td.textContent = (value === null || value === undefined) ? '' : value;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        statusEl.textContent = 'Klaar. ' + allRows.length + ' rijen geladen.';

        // daarna chauffeur-tab voorbereiden
        buildChauffeurData();
        updateChauffeurView(); // initieel Top 10 + grafiek
    }

    // ---- Chauffeur aggregatie opbouwen ----
    function buildChauffeurData() {
        if (chauffeurColIndex === -1) {
            console.warn('Geen chauffeur-kolom gevonden.');
            return;
        }

        const map = new Map(); // naam -> {name, count, rows:[]}

        allRows.forEach(row => {
            let name = row[chauffeurColIndex];
            name = (name && String(name).trim() !== '') ? String(name).trim() : 'Onbekend';

            if (!map.has(name)) {
                map.set(name, { name: name, count: 0, rows: [] });
            }
            const entry = map.get(name);
            entry.count++;
            entry.rows.push(row);
        });

        chauffeurData = Array.from(map.values()).sort((a, b) => b.count - a.count);
    }

    // ---- Chauffeur tabel + grafiek updaten ----
    function updateChauffeurView() {
        const limitSelect = document.getElementById('chauffeur-limit');
        const tbodyCh = document.querySelector('#chauffeur-table tbody');
        tbodyCh.innerHTML = '';

        let limit = parseInt(limitSelect.value, 10);
        if (isNaN(limit) || limit < 0) limit = 10;

        const list = (limit === 0) ? chauffeurData : chauffeurData.slice(0, limit);

        list.forEach(ch => {
            const tr = document.createElement('tr');
            tr.dataset.chauffeur = ch.name;

            const tdName = document.createElement('td');
            tdName.textContent = ch.name;
            const tdCount = document.createElement('td');
            tdCount.textContent = ch.count;

            tr.appendChild(tdName);
            tr.appendChild(tdCount);

            tr.addEventListener('click', () => showChauffeurDetails(ch.name));

            tbodyCh.appendChild(tr);
        });

        buildChauffeurChart(list);
        document.getElementById('chauffeur-selected').textContent =
            'Klik op een chauffeur in de tabel hierboven.';
        document.querySelector('#chauffeur-detail-table thead').innerHTML = '';
        document.querySelector('#chauffeur-detail-table tbody').innerHTML = '';
    }

    // ---- Chauffeur grafiek ----
    function buildChauffeurChart(list) {
        const ctx = document.getElementById('chauffeur-chart').getContext('2d');
        if (chauffeurChart) {
            chauffeurChart.destroy();
        }

        chauffeurChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: list.map(ch => ch.name),
                datasets: [{
                    label: 'Aantal schades',
                    data: list.map(ch => ch.count)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 60,
                            minRotation: 30
                        }
                    },
                    y: {
                        beginAtZero: true,
                        precision: 0
                    }
                }
            }
        });
    }

    // ---- Details gekozen chauffeur ----
    function showChauffeurDetails(name) {
        const infoEl = document.getElementById('chauffeur-selected');
        const theadDetail = document.querySelector('#chauffeur-detail-table thead');
        const tbodyDetail = document.querySelector('#chauffeur-detail-table tbody');

        infoEl.textContent = 'Details voor chauffeur: ' + name;
        theadDetail.innerHTML = '';
        tbodyDetail.innerHTML = '';

        const entry = chauffeurData.find(c => c.name === name);
        if (!entry) return;

        // interessante kolommen zoeken
        const headers = allHeaders;
        const cols = [];

        const addCol = (possibleNames) => {
            const idx = findColumnIndexByNames(headers, possibleNames);
            if (idx !== -1 && !cols.includes(idx)) cols.push(idx);
        };

        // chauffeur altijd eerst
        if (chauffeurColIndex !== -1) cols.push(chauffeurColIndex);

        addCol(['datum']);
        addCol(['locatie']);
        addCol(['bus', 'bus/ tram', 'tram']);
        addCol(['link']);

        // header rij
        const hr = document.createElement('tr');
        cols.forEach(idx => {
            const th = document.createElement('th');
            th.textContent = headers[idx];
            hr.appendChild(th);
        });
        theadDetail.appendChild(hr);

        // data rijen
        entry.rows.forEach(row => {
            const tr = document.createElement('tr');
            cols.forEach(idx => {
                let value = row[idx];
                if (idx === dateColIndex && typeof value === 'number') {
                    value = excelSerialToDateString(value);
                }
                const td = document.createElement('td');
                td.textContent = (value === null || value === undefined) ? '' : value;
                tr.appendChild(td);
            });
            tbodyDetail.appendChild(tr);
        });
    }

    // Select-wijziging Top10/Top20/Alle
    document.getElementById('chauffeur-limit').addEventListener('change', () => {
        updateChauffeurView();
    });

    // ---- Excel inladen ----
    fetch(excelFileUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Kon het Excel-bestand niet laden (HTTP ' + response.status + ')');
            }
            return response.arrayBuffer();
        })
        .then(data => {
            statusEl.textContent = 'Excel-bestand geladen, bezig met verwerken...';

            const uint8 = new Uint8Array(data);
            const workbook = XLSX.read(uint8, { type: 'array' });

            const sheetName = 'BRON';
            if (!workbook.SheetNames.includes(sheetName)) {
                statusEl.textContent = "Tabblad 'BRON' bestaat niet in het Excel-bestand!";
                return;
            }

            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (!rows || rows.length === 0) {
                statusEl.textContent = 'Geen data gevonden in tabblad BRON.';
                return;
            }

            buildAllDataTable(rows);
        })
        .catch(err => {
            console.error(err);
            statusEl.textContent = 'Er ging iets mis bij het laden of verwerken van het Excel-bestand.';
        });
</script>

</body>
</html>
